<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <title>Supporting Multi-Step Commands with Spring Shell</title>
        <meta name="description" content="Out of the box, Spring Shell supports printing command results to the terminal in a fairly basic way. Spring Shell also provides the ExecutionProcessor inter...">
        <link rel="canonical" href="/blog/2015/03/19/supporting-multi-step-commands-with-spring-shell/">
    

    <!-- Site Favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/png" />

    <!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,400i,600,600i|Karla:400,400i,700,700i" rel="stylesheet">

    <!-- CSS Styles -->
    <link href="/assets/css/style.css" rel="stylesheet">
</head>



<body class="layout-post">
    <div id="page" class="site">
        <header id="masthead" class="site-header">
    <div class="site-header-wrap">
        <div class="site-header-inside">

            <div class="site-branding">
                
                <p class="profile">
                    <a href="/">
                        <img src="/assets/images/authorimage_robin-gravatar.png" alt="'s Picture"
                            class="avatar" />
                    </a>
                </p>
                <div class="site-identity">
                    
                    <h1 class="site-title">
                        <a href="/">The Boy Wonders</a>
                    </h1>
                    
                    
                    <p class="site-description">A Blog by Robin Howlett</p>
                    
                </div><!-- .site-identity -->
                
                <button id="menu-toggle" class="menu-toggle"><span class="screen-reader-text">Main Menu</span><span
                        class="icon-menu" aria-hidden="true"></span></button>
            </div><!-- .site-branding -->

            <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
                <div class="site-nav-wrap">
                    <div class="site-nav-inside">
                    <ul class="menu">
                        
                        
                        
                        <li class="menu-item "><a href="/">Home</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/tag/code/">Code</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/tag/horseracing/">Horse Racing</a></li>
                        
                    </ul>
                    <p class="social-links">
    
    <a href="https://twitter.com/robinhowlett" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    <a href="https://github.com/robinhowlett" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    
    
    
    
    <a href="https://www.linkedin.com/in/robinhowlett" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
</p>
                    </div><!-- .site-nav-inside -->
                </div><!-- .site-nav-wrap -->
            </nav><!-- .site-navigation -->

        </div><!-- .site-header-inside -->
    </div><!-- .site-header-wrap -->
</header><!-- .site-header -->
        <div id="content" class="site-content fadeInDown delay_075s">
            <div class="inner-wide">
                    <main id="main" class="site-main">
    
        <article class="post-full inner">

            <header class="post-header">
                <div class="post-meta">
                    <time class="post-date" datetime="2015-03-19">March 19,
                        2015</time>
                </div><!-- .post-meta -->
                <h1 class="post-title">Supporting Multi-Step Commands with Spring Shell</h1>
                
                <div class="post-tags">
                     
                    <a href='tag/code/'>code</a>
                    
                     
                    <a href='tag/spring-shell/'>spring-shell</a>
                    
                    
                </div>
                
            </header><!-- .post-header -->

            
            <div class="post-content">
                <p>Out of the box, <a href="http://docs.spring.io/spring-shell/docs/current/reference/htmlsingle/">Spring Shell</a> supports printing command results to the terminal in a fairly basic way.</p>

<p>Spring Shell also provides the <a href="http://docs.spring.io/spring-shell/docs/current/api/org/springframework/shell/core/ExecutionProcessor.html"><code class="highlighter-rouge">ExecutionProcessor</code></a> interface, allowing a “command provider to be called in a generic fashion just before, and right after, executing a command”.</p>

<p>The interface defines three lifecycle events that can be intercepted:</p>

<ul>
  <li>before a command has been invoked</li>
  <li>after an invocation has been returned</li>
  <li>after an exception was thrown</li>
</ul>

<p>I was interested in hooking into the <code class="highlighter-rouge">afterReturningInvocation</code> to provide “step logic” - potentially allowing user or system input to execute additional logic based on the result of the initial command result (and/or each step result) e.g. paging backwards or forwards on the command line through lists of data.</p>

<p>I was able to achieve this and opened <a href="https://jira.spring.io/browse/SHL-174">a JIRA ticket</a> and the following pull request on Spring Shell’s GitHub repo: <a href="https://github.com/spring-projects/spring-shell/pull/67">SHL-174: Multi-Step Commands #67</a></p>

<!-- more -->

<p>When writing command execution results to the terminal, Spring Shell’s <code class="highlighter-rouge">AbstractShell</code> examines the instance being returned by the command and logs at <code class="highlighter-rouge">INFO</code> level the <code class="highlighter-rouge">toString()</code> output of the result object. If the result object is an instance of <code class="highlighter-rouge">Iterable</code>, it iterates over the collection and logs the <code class="highlighter-rouge">toString()</code> of each entry:</p>

<p>``` java AbstractShell.java
	protected void handleExecutionResult(Object result) {
		if (result instanceof Iterable<?>) {
			for (Object o : (Iterable<?>) result) {
				logger.info(o.toString());
			}
		} else {
			logger.info(result.toString());
		}
	}</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
When planning out my solution, I came up with the following back-of-the-napkin outline:

* a new custom annotation would be created and would be put on the command method. The `ParseResult invocationContext` instance passed into the processor methods could then be checked to see if the method being invoked had that annotation present, denoting a multi-step command.

* an abstract implementation of `ExecutionProcessor` would override the `afterReturningInvocation` method and detect if a multi-step command had been invoked. Command classes requiring multi-step logic would extend this class.

* the step logic would be configurable in that it could:
	* determine if there were more steps to execute, 
	* configure each step in preparation of execution, 
	* execute the step, and 
	* handle each step execution's result (e.g. logging to the shell), if any.

* the solution should also ensure that the command's original/final result was handled correctly.

&lt;p /&gt;
---
**`@CliStepIndicator`**

I created a new annotation that denotes a `@CliCommand`-annotated method supports multi-step processing:

``` java CliStepIndicator.java
@Inherited
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
public @interface CliStepIndicator {

}
</code></pre></div></div>

<p><strong><code class="highlighter-rouge">AbstractStepExecutionProcessor.java</code></strong></p>

<p>I created a new abstract class implementing <code class="highlighter-rouge">ExecutionProcessor</code>. The <code class="highlighter-rouge">afterReturningInvocation</code> method is overridden with the following logic:</p>

<ul>
  <li>checks if this invocation is on a multi-step command</li>
  <li>the initial result from the command is handled and this is fact is stored on the shell</li>
  <li>while there are more steps
    <ul>
      <li>configure the next step</li>
      <li>execute the next step in the workflow</li>
      <li>handle the step execution result</li>
    </ul>
  </li>
</ul>

<script src="https://gist.github.com/robinhowlett/8e84da9f72600736d4f0.js?file=AbstractStepExecutionProcessor.java"> </script>

<h2 id="example">Example</h2>

<p><code class="highlighter-rouge">StepCommand.java</code> is an example command class with a multi-step command (<code class="highlighter-rouge">step-test</code>) method annotated with <code class="highlighter-rouge">@CliStepIndicator</code>.</p>

<p>Each step increments a <code class="highlighter-rouge">int</code> variable (see <code class="highlighter-rouge">configureStep</code>), up to 3 times (see <code class="highlighter-rouge">hasMoreSteps</code>). Each step execution logs that it is executing (see <code class="highlighter-rouge">executeStep</code>), and step results are handled by printing the current <code class="highlighter-rouge">int</code> variable value (see <code class="highlighter-rouge">handleStepExecutionResult</code>).</p>

<script src="https://gist.github.com/robinhowlett/8e84da9f72600736d4f0.js?file=StepCommand.java"> </script>

<p>The following integration test executes both the <code class="highlighter-rouge">step-test</code> multi-step command (to increment the <code class="highlighter-rouge">int</code> variable 3 times) and the <code class="highlighter-rouge">step-check</code> comand (to confirm the incrementation took place).</p>

<script src="https://gist.github.com/robinhowlett/8e84da9f72600736d4f0.js?file=StepCommandsTest.java"> </script>

<p>The test passes and prints the following output:</p>

<p><img src="https://dl.dropboxusercontent.com/s/zy1rx79g8ugpad7/Screenshot%202015-03-19%2022.22.00.png" alt="Test Result" /></p>

<p>I’ll be posting shortly about how I used this feature in a recent CLI project to navigate API pagination, run simulations, diff audit log entries etc.</p>

            </div>
            <footer class="post-footer">
                <div class="post-share">
                    <span class="post-share-title">Share:</span>
                    <a target="_blank" href="https://twitter.com/share?text=Supporting+Multi-Step+Commands+with+Spring+Shell&amp;url=http://www.robinhowlett.com/blog/2015/03/19/supporting-multi-step-commands-with-spring-shell/">Twitter</a>
                    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.robinhowlett.com/blog/2015/03/19/supporting-multi-step-commands-with-spring-shell/">Facebook</a>
                </div><!-- .share-post -->
            </footer>
            
<section id="comments-area" class="comments-area">
    <h2 class="comments-title">Comments</h2>
    <div class="comments-inside">
        <div id="disqus_thread"></div>
    </div><!-- .comments-inside -->
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section><!-- .comments-area -->
<script type="text/javascript">
    var disqus_shortname = 'robinhowlett';
    var disqus_developer = 0;
    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</section>

        </article>
        
        <section class="read-next inner">
            <h2 class="read-next-title">Read Next</h2>
            
            <article class="post">
                <header class="post-header">
                    <div class="post-meta">
                        <time class="published" datetime="March 19, 2015">March 19, 2015</time>
                    </div>
                    <h3 class="post-title"><a href="/blog/2015/03/19/adding-java-config-support-to-spring-shell/">Adding Java Config support to Spring Shell</a></h3>
                    <p class="post-tags">
                        
                        
                        
                        <a href='/tag/code/'>Code</a>
                        
                        
                        
                        <a href='/tag/java/'>Java</a>
                        
                        
                        
                        <a href='/tag/spring/'>Spring</a>
                        
                        
                        
                        <a href='/tag/spring-shell/'>Spring-shell</a>
                        
                        
                        
                    </p>
                </header>
            </article>
            
            
            <article class="post">
                <header class="post-header">
                    <div class="post-meta">
                        <time class="published" datetime="April 26, 2015">April 26, 2015</time>
                    </div>
                    <h3 class="post-title"><a href="/blog/2015/04/26/spring-social-bootstrap-create-rest-api-sdks-and-clis-that-can-record-and-replay-http-requests/">Spring Social Bootstrap: Create REST API SDKs and CLIs that can Record and Replay HTTP requests</a></h3>
                    <p class="post-tags">
                        
                        
                        
                        <a href='/tag/code/'>Code</a>
                        
                        
                        
                        <a href='/tag/spring/'>Spring</a>
                        
                        
                        
                    </p>
                </header>
            </article>
            
        </section><!-- .read-next -->

        <!-- Create a sorted array of tags -->
         
        <section class="tagcloud inner">
            <h2 class="tagcloud-title">Tags</h2>
            <div class="tag-links">
                
                <a href='http://www.robinhowlett.com/tag/career/'>career</a>
                
                <a href='http://www.robinhowlett.com/tag/chrome/'>chrome</a>
                
                <a href='http://www.robinhowlett.com/tag/code/'>code</a>
                
                <a href='http://www.robinhowlett.com/tag/dataviz/'>dataviz</a>
                
                <a href='http://www.robinhowlett.com/tag/horseracing/'>horseracing</a>
                
                <a href='http://www.robinhowlett.com/tag/jackson/'>jackson</a>
                
                <a href='http://www.robinhowlett.com/tag/java/'>java</a>
                
                <a href='http://www.robinhowlett.com/tag/maven/'>maven</a>
                
                <a href='http://www.robinhowlett.com/tag/rest/'>rest</a>
                
                <a href='http://www.robinhowlett.com/tag/sankey/'>sankey</a>
                
                <a href='http://www.robinhowlett.com/tag/snaplogic/'>snaplogic</a>
                
                <a href='http://www.robinhowlett.com/tag/spring/'>spring</a>
                
                <a href='http://www.robinhowlett.com/tag/spring-shell/'>spring-shell</a>
                
                <a href='http://www.robinhowlett.com/tag/ssl/'>ssl</a>
                
                <a href='http://www.robinhowlett.com/tag/tls/'>tls</a>
                
                <a href='http://www.robinhowlett.com/tag/wagering/'>wagering</a>
                
            </div><!-- .tag-links -->
        </section><!-- .tagcloud -->

    </main><!-- .site-main -->

                

                
                <footer id="colophon" class="site-footer">
    <p class="site-info inner">
        <a href="#">The Boy Wonders</a> &copy; 2019. Royce theme by
        <a target="_blank" href="https://justgoodthemes.com/">JustGoodThemes</a>.
        <br />
        Powered by <a target="_blank" href="https://jekyllrb.com/">Jekyll</a>.
    </p>
    <a id="back-to-top" class="back-to-top" href="#page">
        <span class="icon-arrow-up" aria-hidden="true"></span>
        <span class="screen-reader-text">Back to top</span>
    </a>
</footer><!-- .site-footer -->
            </div><!-- .inner-wide -->
        </div><!-- .site-content -->
    </div><!-- .site -->

    
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-35552317-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-35552317-2', { 'anonymize_ip': true });
  </script>

    <!-- Javascript Assets -->
    <script src="/assets/js/jquery-3.3.1.min.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/custom.js"></script>

</body>

</html>