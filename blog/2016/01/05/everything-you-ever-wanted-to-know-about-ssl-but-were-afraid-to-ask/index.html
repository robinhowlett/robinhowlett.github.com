<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <title>Everything you ever wanted to know about SSL (but were afraid to ask)</title>
        <meta name="description" content="Or perhaps more accurately, “practical things I’ve learned about SSL”. This post (and the companion Spring Boot application) will demonstrate using SSL certi...">
        <link rel="canonical" href="/blog/2016/01/05/everything-you-ever-wanted-to-know-about-ssl-but-were-afraid-to-ask/">
    

    <!-- Site Favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/png" />

    <!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,400i,600,600i|Karla:400,400i,700,700i" rel="stylesheet">

    <!-- CSS Styles -->
    <link href="/assets/css/style.css" rel="stylesheet">
</head>



<body class="layout-post">
    <div id="page" class="site">
        <header id="masthead" class="site-header">
    <div class="site-header-wrap">
        <div class="site-header-inside">

            <div class="site-branding">
                
                <p class="profile">
                    <a href="/">
                        <img src="/assets/images/authorimage_robin-gravatar.png" alt="'s Picture"
                            class="avatar" />
                    </a>
                </p>
                <div class="site-identity">
                    
                    <h1 class="site-title">
                        <a href="/">The Boy Wonders</a>
                    </h1>
                    
                    
                    <p class="site-description">A Blog by Robin Howlett</p>
                    
                </div><!-- .site-identity -->
                
                <button id="menu-toggle" class="menu-toggle"><span class="screen-reader-text">Main Menu</span><span
                        class="icon-menu" aria-hidden="true"></span></button>
            </div><!-- .site-branding -->

            <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
                <div class="site-nav-wrap">
                    <div class="site-nav-inside">
                    <ul class="menu">
                        
                    </ul>
                    <p class="social-links">
    
    <a href="https://twitter.com/robinhowlett" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    <a href="https://github.com/robinhowlett" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    
    
    
    
    <a href="https://www.linkedin.com/in/robinhowlett" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
</p>
                    </div><!-- .site-nav-inside -->
                </div><!-- .site-nav-wrap -->
            </nav><!-- .site-navigation -->

        </div><!-- .site-header-inside -->
    </div><!-- .site-header-wrap -->
</header><!-- .site-header -->
        <div id="content" class="site-content fadeInDown delay_075s">
            <div class="inner-wide">
                    <main id="main" class="site-main">
    
        <article class="post-full inner">

            <header class="post-header">
                <div class="post-meta">
                    <time class="post-date" datetime="2016-01-05">January 5,
                        2016</time>
                </div><!-- .post-meta -->
                <h1 class="post-title">Everything you ever wanted to know about SSL (but were afraid to ask)</h1>
                
                <div class="post-tags">
                     
                    <a href='tag/ssl/'>ssl</a>
                    
                     
                    <a href='tag/tls/'>tls</a>
                    
                     
                    <a href='tag/rest/'>rest</a>
                    
                    
                </div>
                
            </header><!-- .post-header -->

            
            <div class="post-content">
                <blockquote>
  <p>Or perhaps more accurately, “practical things I’ve learned about SSL”. This post (and the <a href="https://github.com/robinhowlett/everything-ssl">companion Spring Boot application</a>) will demonstrate using SSL certificates to validate and authenticate connections to secure endpoints over HTTPS for some common use cases (web servers, browser authentication, unit and integration testing). It shows how to configure Apache HTTP server for two-way SSL, unit testing SSL authentication with Apache’s <code class="highlighter-rouge">HttpClient</code> and <code class="highlighter-rouge">HttpServer</code> (Java), and integration testing a REST API within a Spring Boot application running on an embedded Tomcat container.</p>
</blockquote>

<p>There are lots of ways for a client to authenticate itself against a server, including basic authentication, form-based authentication, and OAuth.</p>

<p>To prevent exposing user credentials over the wire, the client communicates with the server over HTTPS, and the server’s identify is confirmed by validating its SSL certificate. The server doesn’t necessarily care who the client is, just as long as they have the correct credentials.</p>

<p>An even higher level of security can be gained with using SSL certificates for both the client and the server.</p>

<p>Two-way SSL authentication (also known as “mutual authentication”, and “TLS/SSL with client certificates”) refers to two parties authenticating each other through verifying provided digital certificates, so that both parties are assured of the other’s identity.</p>

<!-- more -->

<ul>
	<li><a href="#terminology">Terminology</a></li>
	<li><a href="#authentication-with-ssl">Authentication with SSL</a></li>
	<ul>
		<li><a href="#one-way-ssl-authentication-server---client">One-way SSL (server -&gt; client)</a></li>
		<li><a href="#two-way-ssl-authentication-server---client">Two-way SSL (server &lt;-&gt; client)</a></li>
		<li><a href="#file-formats-for-certs-and-keys">File Formats for Certs and Keys</a></li>
		<li><a href="#tools">Tools</a></li>
		<li><a href="#pki-and-the-ssl-certificate-chain-the-chain-of-trust">PKI and the SSL Certificate Chain ("the Chain of Trust")</a></li>
	</ul>
	<li><a href="#create-a-local-ssl-server-with-apache">Create a local SSL server with Apache</a></li>
	<ul>
		<li><a href="#configuring-apache-creating-a-site">Configuring Apache: Creating a Site</a></li>
		<li><a href="#configuring-ssl">Configuring SSL</a></li>
	</ul>
	<li><a href="#unit-testing-ssl-authentication-with-apaches-httpclient-and-httpserver">Unit Testing SSL Authentication with Apache’s HttpClient and HttpServer</a></li>
	<ul>
		<li><a href="#java-keystores-jks">Java KeyStores (JKS)</a></li>
		<li><a href="#creating-keystores-and-truststores-with-keytool">Creating KeyStores and TrustStores with Keytool</a></li>
		<li><a href="#one-way-ssl">One-Way SSL</a></li>
		<li><a href="#two-way-ssl-client-certificates">Two-Way SSL (Client Certificates)</a></li>
	</ul>
	<li><a href="#two-way-ssl-authentication-with-spring-boot-embedded-tomcat-and-resttemplate">Two-Way SSL Authentication with Spring Boot, embedded Tomcat and RestTemplate</a></li>
	<ul>
		<li><a href="#integration-testing-ssl-authentication-with-springs-testresttemplate">Integration Testing SSL Authentication with Spring’s TestRestTemplate</a></li>
	</ul>
	<li><a href="#two-way-ssl-with-snaplogics-rest-snap">Two-Way SSL with SnapLogic's REST Snap</a></li>
</ul>

<h2 id="terminology">Terminology</h2>

<p><strong>TLS vs SSL</strong></p>

<p>TLS is the successor to SSL. It is a protocol that ensures privacy between communicating applications. Unless otherwise stated, in this document consider TLS and SSL as interchangable.</p>

<p><strong>Certificate (cert)</strong></p>

<p>The public half of a public/private key pair with some additional metadata about who issued it etc. It may be freely given to anyone.</p>

<p><strong>Private Key</strong></p>

<p>A private key can verify that its corresponding certificate/public key was used to encrypt data. It is never given out publicly.</p>

<p><strong>Certificate Authority (CA)</strong></p>

<p>A company that issues digital certificates. For SSL/TLS certificates, there are a small number of providers (e.g. Symantec/Versign/Thawte, Comodo, GoDaddy, LetsEncrypt) whose certificates are included by most browsers and Operating Systems. They serve the purpose of a “trusted third party”.</p>

<p><strong>Certificate Signing Request (CSR)</strong></p>

<p>A file generated with a private key. A CSR can be sent to a CA to request to be signed. The CA uses its private key to digitally sign the CSR and create a signed cert. Browsers can then use the CA’s cert to validate the new cert has been approved by the CA.</p>

<p><strong>X.509</strong></p>

<p>A specification governing the format and usage of certificates.</p>

<h2 id="authentication-with-ssl">Authentication with SSL</h2>

<p>SSL is the standard security technology for establishing an encrypted link between a web server and a browser. Normally when a browser (the client) establishes an SSL connection to a secure web site, only the server certificate is checked. The browser either relies on itself or the operating system providing a list of certs that have been designated as root certificates and to be trusted as CAs.</p>

<h3 id="one-way-ssl-authentication-server---client">One-way SSL authentication (server -&gt; client)</h3>

<p>Client and server use 9 handshake messages to establish the encrypted channel prior to message exchanging:</p>

<ol>
  <li>Client sends <code class="highlighter-rouge">ClientHello</code> message proposing SSL options.</li>
  <li>Server responds with <code class="highlighter-rouge">ServerHello</code> message selecting the SSL options.</li>
  <li>Server sends <code class="highlighter-rouge">Certificate</code> message, which contains the server’s certificate.</li>
  <li>Server concludes its part of the negotiation with <code class="highlighter-rouge">ServerHelloDone</code> message.</li>
  <li>Client sends session key information (encrypted with server’s public key) in <code class="highlighter-rouge">ClientKeyExchange</code> message.</li>
  <li>Client sends <code class="highlighter-rouge">ChangeCipherSpec</code> message to activate the negotiated options for all future messages it will send.</li>
  <li>Client sends <code class="highlighter-rouge">Finished</code> message to let the server check the newly activated options.</li>
  <li>Server sends <code class="highlighter-rouge">ChangeCipherSpec</code> message to activate the negotiated options for all future messages it will send.</li>
  <li>Server sends <code class="highlighter-rouge">Finished</code> message to let the client check the newly activated options.</li>
</ol>

<h3 id="two-way-ssl-authentication-server---client">Two-way SSL authentication (server &lt;-&gt; client)</h3>

<p>Client and server use 12 handshake messages to establish the encrypted channel prior to message exchanging:</p>

<ol>
  <li>Client sends <code class="highlighter-rouge">ClientHello</code> message proposing SSL options.</li>
  <li>Server responds with <code class="highlighter-rouge">ServerHello</code> message selecting the SSL options.</li>
  <li>Server sends <code class="highlighter-rouge">Certificate</code> message, which contains the server’s certificate.</li>
  <li>Server requests client’s certificate in <code class="highlighter-rouge">CertificateRequest</code> message, so that the connection can be mutually authenticated.</li>
  <li>Server concludes its part of the negotiation with <code class="highlighter-rouge">ServerHelloDone</code> message.</li>
  <li>Client responds with <code class="highlighter-rouge">Certificate</code> message, which contains the client’s certificate.</li>
  <li>Client sends session key information (encrypted with server’s public key) in <code class="highlighter-rouge">ClientKeyExchange</code> message.</li>
  <li>Client sends a <code class="highlighter-rouge">CertificateVerify</code> message to let the server know it owns the sent certificate.</li>
  <li>Client sends <code class="highlighter-rouge">ChangeCipherSpec</code> message to activate the negotiated options for all future messages it will send.</li>
  <li>Client sends <code class="highlighter-rouge">Finished</code> message to let the server check the newly activated options.</li>
  <li>Server sends <code class="highlighter-rouge">ChangeCipherSpec</code> message to activate the negotiated options for all future messages it will send.</li>
  <li>Server sends <code class="highlighter-rouge">Finished</code> message to let the client check the newly activated options.</li>
</ol>

<h3 id="file-formats-for-certs-and-keys">File Formats for Certs and Keys</h3>

<p><strong>Privacy-Enhanced Mail (PEM)</strong></p>

<p>PEM is just Distinguished Encoding Rules (DER) that has been Base64 encoded. Used for keys and certificates.</p>

<p><strong>PKCS12</strong></p>

<p>PKCS12 is a password-protected format that can contain multiple certificates and keys.</p>

<p><strong>Java KeyStore (JKS)</strong></p>

<p>Java version of PKCS12 and also password protected. Entries in a JKS file must have an “alias” that is unique. If an alias is not specified, “mykey” is used by default. It’s like a database for certs and keys.</p>

<h3 id="tools">Tools</h3>

<p><strong>OpenSSL</strong></p>

<p>An open source toolkit implementing the SSL (v2/v3) and TLS (v1) protocols, as well as a full-strength general purpose cryptography library.</p>

<p><strong>Keytool</strong></p>

<p>Manages a Java KeyStore of cryptographic keys, X.509 certificate chains, and trusted certificates. Ships with the JDK.</p>

<p><strong>XCA</strong></p>

<p>A graphical tool to create and manage certificates.</p>

<h3 id="pki-and-the-ssl-certificate-chain-the-chain-of-trust">PKI and the SSL Certificate Chain (“the Chain of Trust”)</h3>

<p>All SSL/TLS connections rely on a chain of trust called the SSL Certificate Chain. Part of <a href="https://en.wikipedia.org/wiki/Public_key_infrastructure">PKI (Public Key Infrastructure)</a>, this chain of trust is established by certificate authorities (CAs) who serve as trust anchors that verify the validity of the systems being communicated with. Each client (browser, OS, etc.) ships with a list of trusted CAs.</p>

<h4 id="ca-signed-certificates">CA-signed Certificates</h4>

<p><img src="https://snaplogic.box.com/shared/static/l4ycer6wclvp72var32be9ru0ykjzjzn.png" alt="Chain of Trust" /></p>

<p>In the above example, the wildcard certificate for “<code class="highlighter-rouge">*.elastic.snaplogic.com</code>” has been issued by the “Go Daddy Secure Certificate Authority - G2” intermediate CA, which in turn was issued by the “Go Daddy Root Certificate Authority - G2” root CA.</p>

<blockquote>
  <p>Many organizations will create their own internal, self-signed root CA to be used to sign certificates for PKI use within that organization. Then, if each system trusts that CA, the certificates that are issued and signed by that CA will be trusted too.</p>
</blockquote>

<p>To trust a system that presents a the above certificate at a particular domain (e.g. <code class="highlighter-rouge">https://elastic.snaplogic.com</code>), the client system must trust both the intermediate CA and the root CA (the public certs of those CAs must exist in the client system’s trust/CA store), as well as verifying the chain is valid (signatures match, domain names match, and other requirements of the X.509 standard).</p>

<p>Once a client trusts the intermediate and root CAs, all valid certificates signed by those CAs will be trusted by the client.</p>

<blockquote>
  <p>If only particular certificates signed by a trusted CA should be trusted, then either limiting the certificates in the CA store, or checking for certain certificate fingerprints, etc. should be considered instead.</p>
</blockquote>

<h4 id="self-signed-certificates">Self-signed Certificates</h4>

<p>Self-signed certificates have a chain length of 1 - they are not signed by a CA but by the certificate creator itself. All root certificates are self-signed (a chain has to start somewhere).</p>

<p>For example, to create a self-signed certificate (plus private key) for <code class="highlighter-rouge">localhost</code>, the following OpenSSL command may be used:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| root@SL-MBP-RHOWLETT.local:/private/etc/apache2/ssl 
| =&gt; openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout localhost_self-signed.key -out localhost_self-signed.pem
Generating a 2048 bit RSA private key
................................................+++
..............................+++
writing new private key to 'localhost_self-signed.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:US
State or Province Name (full name) [Some-State]:Colorado
Locality Name (eg, city) []:Boulder
Organization Name (eg, company) [Internet Widgits Pty Ltd]:SnapLogic
Organizational Unit Name (eg, section) []:SnapTeam
Common Name (e.g. server FQDN or YOUR name) []:localhost
Email Address []:
</code></pre></div></div>

<blockquote>
  <p>The <code class="highlighter-rouge">"Common Name"</code> must match the domain that will be presenting the certificate e.g. <code class="highlighter-rouge">localhost</code></p>
</blockquote>

<p>To create a <code class="highlighter-rouge">.p12</code> file (that can be imported and trusted within OS X’s Keychain application for example):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| root@SL-MBP-RHOWLETT.local:/private/etc/apache2/ssl 
| =&gt; openssl pkcs12 -export -in /etc/apache2/ssl/localhost_self-signed.pem -inkey /etc/apache2/ssl/localhost_self-signed.key -name "SelfSignedServer" -out localhost_self-signed.p12
Enter Export Password:
Verifying - Enter Export Password:
</code></pre></div></div>

<p>When you want to specifically control a small number of certificates to use within an internal network you control, self-signed certificates can be very useful.</p>

<h2 id="create-a-local-ssl-server-with-apache">Create a local SSL server with Apache</h2>

<p>Modified from: <a href="https://gist.github.com/jonathantneal/774e4b0b3d4d739cbc53">https://gist.github.com/jonathantneal/774e4b0b3d4d739cbc53</a></p>

<p><strong>Configuring Apache</strong></p>

<p>Switch to root:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo su
</code></pre></div></div>

<p>Within Terminal, start Apache:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl start
</code></pre></div></div>

<p>In a web browser, visit <a href="http://localhost">http://localhost</a>. You should see a message stating that <strong>It works!</strong></p>

<p><strong>Configuring Apache for HTTP: Setting up a port 80 Virtual Host</strong></p>

<p>Within Terminal, edit the Apache Configuration:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/apache2/httpd.conf
</code></pre></div></div>

<p>Enable SSL by uncommenting line 143:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LoadModule ssl_module libexec/apache2/mod_ssl.so
</code></pre></div></div>

<p>Within your editor, replace line 212 to suppress messages about the server’s fully qualified domain name:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ServerName localhost
</code></pre></div></div>

<p>Next, uncomment line 160 and line 499 to enable Virtual Hosts.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LoadModule vhost_alias_module libexec/apache2/mod_vhost_alias.so

Include /private/etc/apache2/extra/httpd-vhosts.conf
</code></pre></div></div>

<p>Uncomment line 518 to include httpd-ssl.conf (to listen on port 443):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Include /private/etc/apache2/extra/httpd-ssl.conf
</code></pre></div></div>

<p>Optionally, uncomment line 169 to enable PHP.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LoadModule php5_module libexec/apache2/libphp5.so
</code></pre></div></div>

<p>Within Terminal, edit the Virtual Hosts</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/apache2/extra/httpd-vhosts.conf
</code></pre></div></div>

<p>Within your editor, replace the entire contents of this file with the following, replacing <code class="highlighter-rouge">rhowlett</code> with your user name.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
    ServerName localhost
    DocumentRoot "/Users/rhowlett/Sites/localhost"

    &lt;Directory "/Users/rhowlett/Sites/localhost"&gt;
        Options Indexes FollowSymLinks
        AllowOverride All
        Order allow,deny
        Allow from all
        Require all granted
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre></div></div>

<p>Within Terminal, restart Apache:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl restart
</code></pre></div></div>

<h3 id="configuring-apache-creating-a-site">Configuring Apache: Creating a Site</h3>

<p>Within <strong>Terminal</strong>, Create a <strong>Sites</strong> directory, which will be the parent directory of many individual Site subdirectories:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir ~/Sites
</code></pre></div></div>

<p>Next, create a <strong>localhost</strong> subdirectory within <strong>Sites</strong>, which will be our first site:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir ~/Sites/localhost
</code></pre></div></div>

<p>Finally, create an HTML document within <strong>localhost</strong>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "&lt;h1&gt;localhost works&lt;/h1&gt;" &gt; ~/Sites/localhost/index.html
</code></pre></div></div>

<p>Now, in a web browser, visit <a href="http://localhost">http://localhost</a>. You should see a message stating that localhost works.</p>

<h3 id="configuring-ssl">Configuring SSL</h3>

<p><em><strong>Note</strong></em>: I used <code class="highlighter-rouge">snaplogic</code> for all passwords below</p>

<p>Modified from: <a href="http://www.stefanocapitanio.com/configuring-two-way-authentication-ssl-with-apache/">http://www.stefanocapitanio.com/configuring-two-way-authentication-ssl-with-apache/</a></p>

<p>Within <strong>Terminal</strong>, create a SSL directory:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /etc/apache2/ssl

cd /etc/apache2/ssl
mkdir certs private
</code></pre></div></div>

<p><strong>Create the CA cert</strong></p>

<p>Create a database to keep track of each certificate signed:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo '100001' &gt; serial
touch certindex.txt
</code></pre></div></div>

<p>Make a custom config file for openssl to use:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi openssl.cnf
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#
# OpenSSL configuration file.
#

# Establish working directory.

dir = .

[ ca ]
default_ca = CA_default

[ CA_default ]
serial = $dir/serial
database = $dir/certindex.txt
new_certs_dir = $dir/certs
certificate = $dir/cacert.pem
private_key = $dir/private/cakey.pem
default_days = 365
default_md = sha512
preserve = no
email_in_dn = no
nameopt = default_ca
certopt = default_ca
policy = policy_match

[ policy_match ]
countryName = match
stateOrProvinceName = match
organizationName = match
organizationalUnitName = optional
commonName = supplied
emailAddress = optional

[ req ]
default_bits = 2048 # Size of keys
default_keyfile = key.pem # name of generated keys
default_md = sha512 # message digest algorithm
string_mask = nombstr # permitted characters
distinguished_name = req_distinguished_name
req_extensions = v3_req

[ req_distinguished_name ]
countryName = Country Name (2 letter code)
countryName_default = US
countryName_min = 2
countryName_max = 2

stateOrProvinceName = State or Province Name (full name)
stateOrProvinceName_default = Colorado

localityName = Locality Name (eg, city)
localityName_default = Boulder

0.organizationName = Organization Name (eg, company)
0.organizationName_default = SnapLogic

# we can do this but it is not needed normally :-)
#1.organizationName = Second Organization Name (eg, company)
#1.organizationName_default = World Wide Web Pty Ltd

organizationalUnitName = Organizational Unit Name (eg, section)
organizationalUnitName_default = SnapTeam

commonName = Common Name (eg, YOUR name)
commonName_max = 64
commonName_default = localhost 

emailAddress = Email Address
emailAddress_max = 64

# SET-ex3 = SET extension number 3

[ req_attributes ]
challengePassword = A challenge password
challengePassword_min = 4
challengePassword_max = 20

unstructuredName = An optional company name

[ req_distinguished_name ]
countryName = Country Name (2 letter code)
countryName_default = US 
countryName_min = 2
countryName_max = 2

stateOrProvinceName = State or Province Name (full name)
stateOrProvinceName_default = Colorado

localityName = Locality Name (eg, city)

0.organizationName = Organization Name (eg, company)
0.organizationName_default = SnapLogic

# we can do this but it is not needed normally :-)
#1.organizationName = Second Organization Name (eg, company)
#1.organizationName_default = World Wide Web Pty Ltd

organizationalUnitName = Organizational Unit Name (eg, section)
organizationalUnitName_default = SnapTeam

commonName = Common Name (eg, YOUR name)
commonName_max = 64
commonName_default = localhost

emailAddress = Email Address
emailAddress_max = 64

# SET-ex3 = SET extension number 3

[ req_attributes ]
challengePassword = A challenge password
challengePassword_min = 4
challengePassword_max = 20

unstructuredName = An optional company name
[ v3_ca ]
basicConstraints = CA:TRUE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer:always

[ v3_req ]
basicConstraints = CA:FALSE
subjectKeyIdentifier = hash
</code></pre></div></div>

<p>Note that I’ve set <code class="highlighter-rouge">default_md</code> to <code class="highlighter-rouge">sha512</code> so that modern browsers won’t complain about <a href="http://michaelwyres.com/2012/05/chrome-weak-signature-algorithm-solved/">Weak Signature Algorithms</a>.</p>

<p>Create a CA by creating a root certificate. This will create the private key (<code class="highlighter-rouge">private/cakey.pem</code>) and the public key (<code class="highlighter-rouge">cacert.pem</code>, a.k.a. the certificate) of the root CA. Use the default <strong>localhost</strong> for the common name:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| root@SL-MBP-RHOWLETT.local:/private/etc/apache2/ssl 
| =&gt; openssl req -new -x509 -extensions v3_ca -keyout private/cakey.pem -out cacert.pem -days 365 -config ./openssl.cnf
Generating a 2048 bit RSA private key
................................+++
.............................+++
writing new private key to 'private/cakey.pem'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
phrase is too short, needs to be at least 4 chars
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [US]:
State or Province Name (full name) [Colorado]:
Locality Name (eg, city) [Milan]:Boulder
Organization Name (eg, company) [Organization default]:SnapLogic
Organizational Unit Name (eg, section) [SnapLogic]:SnapTeam 
Common Name (eg, YOUR name) [localhost]:
Email Address []:
</code></pre></div></div>

<p><strong>Create the Server cert</strong></p>

<p>Create a key and signing request for the server. This will create the CSR for the server (server-req.pem) and the server’s private key (private/server-key.pem). Use the default localhost for the common name:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| root@SL-MBP-RHOWLETT.local:/etc/apache2/ssl 
| =&gt; openssl req -new -nodes -out server-req.pem -keyout private/server-key.pem -days 365 -config openssl.cnf 
Generating a 2048 bit RSA private key
......+++
..................................+++
writing new private key to 'private/server-key.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [US]:
State or Province Name (full name) [Colorado]:
Locality Name (eg, city) [Boulder]:
Organization Name (eg, company) [SnapLogic]:
Organizational Unit Name (eg, section) [SnapTeam]:
Common Name (eg, YOUR name) [localhost]:
Email Address []:
</code></pre></div></div>

<p>Have the CA sign the server’s CSR. This will create the server’s public certificate (<code class="highlighter-rouge">server-cert.pem</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| root@SL-MBP-RHOWLETT.local:/etc/apache2/ssl 
| =&gt; openssl ca -out server-cert.pem -days 365 -config openssl.cnf -infiles server-req.pem 
Using configuration from openssl.cnf
Enter pass phrase for ./private/cakey.pem:
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'US'
stateOrProvinceName   :PRINTABLE:'Colorado'
localityName          :PRINTABLE:'Boulder'
organizationName      :PRINTABLE:'SnapLogic'
organizationalUnitName:PRINTABLE:'SnapTeam'
commonName            :PRINTABLE:'localhost'
Certificate is to be certified until Oct  4 16:30:23 2016 GMT (365 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
</code></pre></div></div>

<p><strong>Create the Client cert</strong></p>

<p>Each client will create a key and signing request. We will just create one for now. You must use a different common name than the server/CA - here I’m using <code class="highlighter-rouge">client</code>. This will create the client’s CSR (<code class="highlighter-rouge">client-req.pem</code>) and the client’s private key (<code class="highlighter-rouge">private/client-key.pem</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| root@SL-MBP-RHOWLETT.local:/etc/apache2/ssl 
| =&gt; openssl req -new -nodes -out client-req.pem -keyout private/client-key.pem -days 365 -config openssl.cnf 
Generating a 2048 bit RSA private key
....................................................+++
...........+++
writing new private key to 'private/client-key.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [US]:
State or Province Name (full name) [Colorado]:
Locality Name (eg, city) [Boulder]:
Organization Name (eg, company) [SnapLogic]:
Organizational Unit Name (eg, section) [SnapTeam]:
Common Name (eg, YOUR name) [localhost]:client
Email Address []:
</code></pre></div></div>

<p>Have the CA sign the client’s CSR. This will create the client’s public certificate (<code class="highlighter-rouge">client-cert.pem</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| root@SL-MBP-RHOWLETT.local:/etc/apache2/ssl 
| =&gt; openssl ca -out client-cert.pem -days 365 -config openssl.cnf -infiles client-req.pem 
Using configuration from openssl.cnf
Enter pass phrase for ./private/cakey.pem:
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'US'
stateOrProvinceName   :PRINTABLE:'Colorado'
localityName          :PRINTABLE:'Boulder'
organizationName      :PRINTABLE:'SnapLogic'
organizationalUnitName:PRINTABLE:'SnapTeam'
commonName            :PRINTABLE:'client'
Certificate is to be certified until Oct  4 16:40:01 2016 GMT (365 days)
Sign the certificate? [y/n]:y

1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
</code></pre></div></div>

<p>Finally, create the PKCS12 file using the client’s private key, the client’s public cert and the CA cert. This will create the (Mac-friendly) PKCS12 file (<code class="highlighter-rouge">client-cert.p12</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| root@SL-MBP-RHOWLETT.local:/etc/apache2/ssl 
| =&gt; openssl pkcs12 -export -in client-cert.pem -inkey private/client-key.pem -certfile cacert.pem -name "Client" -out client-cert.p12 
Enter Export Password:
Verifying - Enter Export Password:
</code></pre></div></div>

<p><strong>Configuring Apache for HTTPS and one-way SSL auth</strong></p>

<p>As root:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/apache2/extra/httpd-vhosts.conf
</code></pre></div></div>

<p>Add a Virtual Host for port 443 and enable SSL:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
    ServerName localhost
    DocumentRoot "/Users/rhowlett/Sites/localhost"

    &lt;Directory "/Users/rhowlett/Sites/localhost"&gt;
        Options Indexes FollowSymLinks
        AllowOverride All
        Order allow,deny
        Allow from all
        Require all granted
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;

&lt;VirtualHost *:443&gt;
    ServerName localhost
    DocumentRoot "/Users/rhowlett/Sites/localhost"

    SSLCipherSuite HIGH:MEDIUM:!aNULL:!MD5
    SSLEngine on
    SSLCertificateFile /etc/apache2/ssl/server-cert.pem
    SSLCertificateKeyFile /etc/apache2/ssl/private/server-key.pem

    &lt;Directory "/Users/rhowlett/Sites/localhost"&gt;
        Options Indexes FollowSymLinks
        AllowOverride All
        Order allow,deny
        Allow from all
        Require all granted
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre></div></div>

<p>Restart Apache:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl restart
</code></pre></div></div>

<p>(Mac) Install the CA cert into Keychain Access</p>

<p>Open <code class="highlighter-rouge">/etc/apache2/ssl</code> in Finder:</p>

<p><img src="https://snaplogic.box.com/shared/static/v2qvj2qa867hkudz5x4jtxmlbovqnw8o.png" alt="Finder" /></p>

<p>Open the CA cert (<code class="highlighter-rouge">cacert.pem</code>) by double-clicking it to install it to Keychain Access:</p>

<p><img src="https://snaplogic.box.com/shared/static/zgczjbqqu1jxsx6uj7920fj73qw6qvcf.png" alt="Install CA cert" /></p>

<p>Mark it as trusted:</p>

<p><img src="https://snaplogic.box.com/shared/static/rwgi31nmwcfp8ld4bsryfpb884y0y95f.png" alt="Trust CA cert Trusted" />
<img src="https://snaplogic.box.com/shared/static/yj41mm1fi2tpi4mr9n28hsmhgnlqm8c7.png" alt="Trusted" /></p>

<p>Open your browser to <a href="https://localhost">https://localhost</a> and you should see a successful secure connection:</p>

<p><img src="https://snaplogic.box.com/shared/static/v3em6y3nlpdeuki9n3aawpk9ek22lw73.png" alt="Successful HTTPS" /></p>

<p><strong>Configuring Apache for two-way SSL auth</strong></p>

<p>As root:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/apache2/extra/httpd-vhosts.conf
</code></pre></div></div>

<p>Add the <code class="highlighter-rouge">SSLVerifyClient</code>, <code class="highlighter-rouge">SSLCertificateFile</code>, and <code class="highlighter-rouge">SSLCACertificateFile</code> options:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
    ServerName localhost
    DocumentRoot "/Users/rhowlett/Sites/localhost"

    &lt;Directory "/Users/rhowlett/Sites/localhost"&gt;
        Options Indexes FollowSymLinks
        AllowOverride All
        Order allow,deny
        Allow from all
        Require all granted
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;

&lt;VirtualHost *:443&gt;
    ServerName localhost
    DocumentRoot "/Users/rhowlett/Sites/localhost"

    SSLCipherSuite HIGH:MEDIUM:!aNULL:!MD5
    SSLEngine on
    SSLCertificateFile /etc/apache2/ssl/server-cert.pem
    SSLCertificateKeyFile /etc/apache2/ssl/private/server-key.pem

    SSLVerifyClient require
    SSLVerifyDepth 10
    SSLCACertificateFile /etc/apache2/ssl/cacert.pem

    &lt;Directory "/Users/rhowlett/Sites/localhost"&gt;
        Options Indexes FollowSymLinks
        AllowOverride All
        Order allow,deny
        Allow from all
        Require all granted
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre></div></div>

<p>Restart Apache:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl restart
</code></pre></div></div>

<p>OpenSSL can now confirm that the two-way SSL handshake can be successfully completed:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rhowlett@SL-MBP-RHOWLETT.local:~/Downloads 
| =&gt; openssl s_client -connect localhost:443 -tls1 -cert /etc/apache2/ssl/client-cert.pem -key /etc/apache2/ssl/private/client-key.pem
CONNECTED(00000003)
depth=1 /C=US/ST=Colorado/L=Boulder/O=SnapLogic/OU=SnapTeam/CN=localhost
verify error:num=19:self signed certificate in certificate chain
verify return:0
---
Certificate chain
 0 s:/C=US/ST=Colorado/O=SnapLogic/OU=SnapTeam/CN=localhost
   i:/C=US/ST=Colorado/L=Boulder/O=SnapLogic/OU=SnapTeam/CN=localhost
 1 s:/C=US/ST=Colorado/L=Boulder/O=SnapLogic/OU=SnapTeam/CN=localhost
   i:/C=US/ST=Colorado/L=Boulder/O=SnapLogic/OU=SnapTeam/CN=localhost
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIDPjCCAiYCAxAAATANBgkqhkiG9w0BAQ0FADBtMQswCQYDVQQGEwJVUzERMA8G
A1UECBMIQ29sb3JhZG8xEDAOBgNVBAcTB0JvdWxkZXIxEjAQBgNVBAoTCVNuYXBM
b2dpYzERMA8GA1UECxMIU25hcFRlYW0xEjAQBgNVBAMTCWxvY2FsaG9zdDAeFw0x
NTEwMDYxOTE1MTNaFw0xNjEwMDUxOTE1MTNaMFsxCzAJBgNVBAYTAlVTMREwDwYD
VQQIEwhDb2xvcmFkbzESMBAGA1UEChMJU25hcExvZ2ljMREwDwYDVQQLEwhTbmFw
VGVhbTESMBAGA1UEAxMJbG9jYWxob3N0MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A
MIIBCgKCAQEAyvia0x0Nd4tYyvoXEYtI3s/eLIQ3wFsOJIibNy70PLhp35gScQ69
MiIrVDYqIydVbInzyY5kuhttrUIrHCIiDwa5OqEiExJ+ollY9icnrMLrEXJqvv5C
/fduS5byC6StNg7xHQkYlYLUYMw8QQyCZFQVGXlxZeG6i086ffMYduFimkBAkNj5
/LkIwrOELpGnNcrOJxQEnLi8vmRI3oiCrgVc0ugrFBnoj3Tf6y3lx23fYgLbqf9c
bRCS6V3eppa/x9sezv9KQ+pDYly0bwKIcvJ9xLp7qPiO+smGGvS97Ec4NAif8y6v
pU92cPH32cv1p0AIDF0+GMOgVyAYZgSKQwIDAQABMA0GCSqGSIb3DQEBDQUAA4IB
AQBedsAvkB1yNLE2GCJWWQ19qEKOIBYCRQc2z29PgF/LAz5GVOIw/ZiN37C2vTob
jk1NnqfOx5aipQ5Pe5D2yfbarDl0kaqRn9MhBySi+oi3AgUZ5yL0x/nGF9O8jszJ
OM1FUC6qXKic5pR0qTrdXigONlKb0Au+l3z5dFMiqnNmDrNlI8kW1OXrwy/jvyPv
H1bHWAKYFTvHi2v7A0B96V1VvFBLbuQztckPQ3VpFDOwWhWLr2D90vxFd1Ea0SCi
3bysz4ax9XP0bmXJY+968nV31qQJMkk5/3rE5PWVZibsniccfdujgSQYl+yNA3sB
F5h6mCR6pAONZFo6+U3zARSb
-----END CERTIFICATE-----
subject=/C=US/ST=Colorado/O=SnapLogic/OU=SnapTeam/CN=localhost
issuer=/C=US/ST=Colorado/L=Boulder/O=SnapLogic/OU=SnapTeam/CN=localhost
---
Acceptable client certificate CA names
/C=US/ST=Colorado/L=Boulder/O=SnapLogic/OU=SnapTeam/CN=localhost
---
SSL handshake has read 4004 bytes and written 1539 bytes
---
New, TLSv1/SSLv3, Cipher is DHE-RSA-AES256-SHA
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
SSL-Session:
    Protocol  : TLSv1
    Cipher    : DHE-RSA-AES256-SHA
    Session-ID: A1D9CE5273963BCF70503B499D7714ECE2B628CEE59CE554615743ACEEA8E281
    Session-ID-ctx: 
    Master-Key: 0920CEE1491E9A116B2DF959430890D449D49DA990A178C0AC980DD5AF359B7E1CDD4B2D8237C8F81BAE186BC06E7BB0
    Key-Arg   : None
    TLS session ticket:
    0000 - 5c 8f 01 d5 5d c1 62 d5-65 d7 8f 05 5f 47 d2 82   \...].b.e..._G..
    0010 - f0 fd 2c 88 be 58 25 6c-9e 9a 1e 78 6a b4 66 c4   ..,..X%l...xj.f.
    0020 - 0d 3d 31 04 97 a2 5f e7-6f 3c 9f c9 b1 44 6a ab   .=1..._.o&lt;...Dj.
    0030 - 84 89 76 e4 63 9b 81 b7-c3 28 e0 95 c6 c3 f5 89   ..v.c....(......
    0040 - d5 f9 7f da df fb 12 f7-de 2a ec e8 c2 01 59 07   .........*....Y.
    0050 - 9e ad 91 56 91 34 88 73-66 d1 ea c1 72 dc 56 ee   ...V.4.sf...r.V.
    0060 - ee 61 fe 5e 38 f0 aa d6-3a 7d ad ef e6 be 2a 15   .a.^8...:}....*.
    0070 - dc cc 9f 04 5e e8 f9 2b-07 21 6b 0f da 9f 08 2e   ....^..+.!k.....
    0080 - 88 af 96 41 98 f3 ff 8a-01 66 1a 1d 61 47 1b e5   ...A.....f..aG..
    0090 - ec ab b7 af 79 aa 7d 25-ca e0 fa f4 2b 2e 9a dd   ....y.}%....+...
    00a0 - 95 0c 4b 35 d8 96 8b f0-1e 20 c1 c3 47 fc 65 ed   ..K5..... ..G.e.
    00b0 - 21 e4 50 59 1e 33 6a 5c-c6 27 f1 65 be 5b 0f 35   !.PY.3j\.'.e.[.5
    00c0 - 1d ba ac bf f5 9c d9 b7-32 87 11 ae b7 87 9b 52   ........2......R
    00d0 - bb 00 6b 66 af e2 94 45-e3 8f fb e0 b4 c6 d7 5a   ..kf...E.......Z
    00e0 - f8 1d 7a af e3 ee bb 6b-93 ff 46 af ed 86 bc f8   ..z....k..F.....
    00f0 - 6d e2 c9 60 eb 61 8e b9-7e bd 4d bb 1e 01 95 d2   m..`.a..~.M.....
    0100 - f5 d5 ee 82 10 4a 1d 23-9e 94 d7 0b 46 e4 d4 32   .....J.#....F..2
    0110 - 11 92 76 4a 94 9e a3 61-21 9b 4c 49 6c df 7b 18   ..vJ...a!.LIl.{.
    0120 - b7 49 66 bd 48 0d eb 9a-ad e9 32 c7 b9 6d 70 1a   .If.H.....2..mp.
    0130 - c7 a1 25 21 b4 f1 03 5b-80 83 e9 da 8d 56 f1 d9   ..%!...[.....V..
    0140 - 8b c5 32 b7 3a 67 5b 9c-51 84 a0 09 04 4f 48 60   ..2.:g[.Q....OH`
    0150 - 27 c0 fe 1c 45 7a 3b b2-22 8d ed 65 72 23 8a bf   '...Ez;."..er#..
    0160 - e3 09 eb 78 98 ec 08 06-9d 37 02 1a 4b ae cd 3a   ...x.....7..K..:
    0170 - 9c a4 bd 5d 47 5e d3 d7-7b 89 7b 97 78 a6 4c 10   ...]G^..{.{.x.L.
    0180 - bf 3e ed 1f f4 fe e5 97-90 ee 31 58 5f ff c6 c2   .&gt;........1X_...
    0190 - 61 b7 df 0a f5 27 c6 a8-ac 61 a3 d0 1e 3a 6a 42   a....'...a...:jB
    01a0 - a9 18 b4 fb 4b 25 87 62-97 26 48 35 d0 16 d1 06   ....K%.b.&amp;H5....
    01b0 - 9d 82 b5 e2 7b f2 24 c5-83 a1 4b fe 8d 38 ae 30   ....{.$...K..8.0
    01c0 - 8e eb e1 ac 8b 48 fa 27-b0 e1 ce b3 17 62 69 f0   .....H.'.....bi.
    01d0 - 30 17 ae 31 9d bf 77 64-66 5b 13 8e a2 63 2e 58   0..1..wdf[...c.X
    01e0 - 02 10 26 e1 3b 0d 55 fc-3d 0f d5 08 2d 1e 28 0a   ..&amp;.;.U.=...-.(.
    01f0 - c2 fd a2 f3 2a 40 25 ed-2b 06 2c 92 c3 78 a3 b3   ....*@%.+.,..x..
    0200 - 35 bc d9 6c 57 97 ca 93-0f f3 b8 e4 60 d8 99 b4   5..lW.......`...
    0210 - b8 ba ae b7 47 4a 59 84-5b f9 5e b2 11 44 42 bd   ....GJY.[.^..DB.
    0220 - e8 46 3d 1d 09 70 72 f6-23 df 89 f8 f7 b7 84 d2   .F=..pr.#.......
    0230 - 7d 42 0e 5d d7 76 c2 da-0b 61 f9 48 3c c9 5f ba   }B.].v...a.H&lt;._.
    0240 - ab be 5f 82 2b 03 07 f1-83 12 69 ee 56 b5 7e 06   .._.+.....i.V.~.
    0250 - 03 d7 8e b3 70 7c 93 75-3d cd e0 a1 1b 8a 14 ef   ....p|.u=.......
    0260 - 91 c6 74 14 1e 16 4c 46-07 c5 62 04 70 a7 fd 5d   ..t...LF..b.p..]
    0270 - e5 67 d8 bf 43 bb 5e f3-7c 37 db 1a 66 cb ad 7d   .g..C.^.|7..f..}
    0280 - cc 30 e4 9b 35 30 b5 6c-d0 4b ba b2 8b 01 71 0e   .0..50.l.K....q.
    0290 - 0a af ec 4e 6a 1a f8 6f-b7 5e 2b b9 e9 ec b6 b6   ...Nj..o.^+.....
    02a0 - 38 1c 70 5c 86 bf ae a4-e6 41 9d c9 9f 40 e4 a0   8.p\.....A...@..
    02b0 - 4b 0d 3d ab 01 90 da 55-cb b8 c8 e6 94 8d 76 35   K.=....U......v5
    02c0 - 94 b5 e2 1a 7c 69 5c b3-ee 08 8b bd 3f 97 c4 31   ....|i\.....?..1
    02d0 - 72 8a 30 a8 c6 3e 74 74-dc 47 c1 d0 ce bd 0b 19   r.0..&gt;tt.G......
    02e0 - f4 93 55 8c 1f 02 b3 6e-f3 4d 44 f1 cc f0 ef 2d   ..U....n.MD....-
    02f0 - 4d 16 92 a3 15 fe 69 db-cc b1 b5 6b d0 4a 49 fc   M.....i....k.JI.
    0300 - 67 9e 0c 47 96 08 0e f2-b2 5c 06 24 45 f3 6a 7d   g..G.....\.$E.j}
    0310 - 6e 1b 2b 9a 68 23 11 3a-43 79 8c 77 9e 98 be 38   n.+.h#.:Cy.w...8
    0320 - 9a 0e e1 a5 17 bd 0f 7b-e0 ac ca 94 ac 48 68 5c   .......{.....Hh\
    0330 - f1 2b 98 b5 8d 36 b6 4f-aa 6f e7 d4 4d a3 f0 4c   .+...6.O.o..M..L
    0340 - cb 09 92 91 01 b9 c2 f1-49 24 64 d3 14 2f a3 5f   ........I$d../._
    0350 - 74 6f c0 54 16 73 c8 40-33 bc 7e e9 3b d8 d5 7c   to.T.s.@3.~.;..|
    0360 - 78 49 5c 80 83 88 4e 4b-46 f2 7a 6b 62 c4 ca 42   xI\...NKF.zkb..B
    0370 - 18 b6 22 40 77 fc 26 0e-28 50 89 7a 14 49 ba b0   .."@w.&amp;.(P.z.I..
    0380 - 2c d7 26 7a 30 f9 9b 90-ba 9a 1f 3b 80 1b 0b 25   ,.&amp;z0......;...%
    0390 - f0 e7 83 83 55 1f 1e f0-71 5b 64 a4 1e 76 91 bb   ....U...q[d..v..
    03a0 - d9 19 f5 2d 2e 54 d7 3a-93 95 29 ae 44 09 e6 cd   ...-.T.:..).D...
    03b0 - ec 79 8d b6 3c 09 d5 05-8d fc 2b 79 88 37 25 92   .y..&lt;.....+y.7%.
    03c0 - 73 ae e6 8a d6 0c 1a eb-7b b9 08 44 4e 81 67 36   s.......{..DN.g6
    03d0 - a6 3a 57 43 d0 ed dc 3e-bb 0f 87 02 f5 fe 80 bb   .:WC...&gt;........
    03e0 - 28 17 6e 7e ad c4 d9 4c-0a 53 fa 41 d2 d2 7c 76   (.n~...L.S.A..|v
    03f0 - a4 95 10 26 1d 5b 7d 19-23 dd 28 a0 48 c1 96 d9   ...&amp;.[}.#.(.H...

    Start Time: 1444189099
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
---
closed
</code></pre></div></div>

<p><strong>(Mac) Install the client PKCS12 file into Keychain Access</strong></p>

<p>Open <code class="highlighter-rouge">/etc/apache2/ssl</code> in Finder and double-click the client PKCS12 file (<code class="highlighter-rouge">client-cert.p12</code>) to install it to Keychain Access:</p>

<p><img src="https://snaplogic.box.com/shared/static/dzwp18utb34mdeyp280ccdn7n5zkyur4.png" alt="Enter client cert password" /></p>

<p><img src="https://snaplogic.box.com/shared/static/lbom67dygm4r2m07pf8merf6i0tm73we.png" alt="Client cert added" /></p>

<p>Open <a href="https://localhost">https://localhost</a> in your browser again and select the client cert when prompted:</p>

<p><img src="https://snaplogic.box.com/shared/static/4s5hq9ksyrqex4ghkhgeb5rdle5bj6yc.png" alt="Select client cert" /></p>

<p>You should then once again see a successful secure connection:</p>

<p><img src="https://snaplogic.box.com/shared/static/v3em6y3nlpdeuki9n3aawpk9ek22lw73.png" alt="Successful two-way SSL" /></p>

<p><a href="http://curl.haxx.se/">cURL</a> will also work:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| =&gt; curl -v --cert /etc/apache2/ssl/client-cert.p12:snaplogic https://localhost
* Rebuilt URL to: https://localhost/
*   Trying ::1...
* Connected to localhost (::1) port 443 (#0)
* WARNING: SSL: Certificate type not set, assuming PKCS#12 format.
* Client certificate: client
</code></pre></div></div>

<p><img src="https://snaplogic.box.com/shared/static/ngbfxftthix3iu78szeb37jf6sg1lrwf.png" alt="curl prompt" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| =&gt; curl -v --cert /etc/apache2/ssl/client-cert.p12:snaplogic https://localhost
* Rebuilt URL to: https://localhost/
*   Trying ::1...
* Connected to localhost (::1) port 443 (#0)
* WARNING: SSL: Certificate type not set, assuming PKCS#12 format.
* Client certificate: client
* TLS 1.0 connection using TLS_DHE_RSA_WITH_AES_256_CBC_SHA
* Server certificate: localhost
* Server certificate: localhost
&gt; GET / HTTP/1.1
&gt; Host: localhost
&gt; User-Agent: curl/7.43.0
&gt; Accept: */*
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Date: Tue, 05 Jan 2016 23:16:29 GMT
&lt; Server: Apache/2.4.16 (Unix) PHP/5.5.29 OpenSSL/0.9.8zg
&lt; Last-Modified: Fri, 02 Oct 2015 18:34:41 GMT
&lt; ETag: "19-521236aaf5240"
&lt; Accept-Ranges: bytes
&lt; Content-Length: 25
&lt; Content-Type: text/html
&lt; 
&lt;h1&gt;localhost works&lt;/h1&gt;
* Connection #0 to host localhost left intact
</code></pre></div></div>

<h2 id="unit-testing-ssl-authentication-with-apaches-httpclient-and-httpserver">Unit Testing SSL Authentication with Apache’s HttpClient and HttpServer</h2>

<p>Apache’s <a href="https://hc.apache.org/">HttpComponents</a> provides <a href="https://hc.apache.org/httpcomponents-client-ga/index.html">HttpClient</a>, “an efficient, up-to-date, and feature-rich package implementing the client side of the most recent HTTP standards and recommendations.”</p>

<p>It also provides <a href="https://hc.apache.org/httpcomponents-core-ga/index.html">HttpCore</a>, which includes an embedded <code class="highlighter-rouge">HttpServer</code>, which can be used for unit testing.</p>

<p>Generate a PKCS12 (<code class="highlighter-rouge">.p12</code>) file from the public <code class="highlighter-rouge">server-cert.pem</code>, the private <code class="highlighter-rouge">server-key.pem</code>, and the CA cert <code class="highlighter-rouge">cacert.pem</code> created above to be used by the local test <code class="highlighter-rouge">HttpServer</code> instance:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rhowlett@SL-MBP-RHOWLETT.local:~/dev/robinhowlett/github/everything-ssl/src/main/resources/ssl 
| =&gt; openssl pkcs12 -export -in /etc/apache2/ssl/server-cert.pem -inkey /etc/apache2/ssl/private/server-key.pem -certfile /etc/apache2/ssl/cacert.pem -name "Server" -out server-cert.p12
Enter Export Password:
Verifying - Enter Export Password:
</code></pre></div></div>

<blockquote>
  <p>If you see <code class="highlighter-rouge">unable to write 'random state'</code>, run <code class="highlighter-rouge">sudo rm ~/.rnd</code> and try again</p>
</blockquote>

<h3 id="java-keystores-jks">Java KeyStores (JKS)</h3>

<p>Java has its own version of PKCS12 called <strong>Java KeyStore (JKS)</strong>. It is also password protected. Entries in a JKS file must have an “alias” that is unique. If an alias is not specified, “mykey” is used by default. It’s like a database for certs and keys.</p>

<p>For both the “KeyStore” and “TrustStore” fields in the REST SSL Account settings, we are going to use JKS files. The difference between them is for terminology reasons: KeyStores provide credentials, TrustStores verify credentials.</p>

<p>Clients will use certificates stored in their TrustStores to verify identities of servers. They will present certificates stored in their KeyStores to servers requiring them.</p>

<p><img src="http://www.websequencediagrams.com/cgi-bin/cdraw?lz=bm90ZSBvdmVyIENsaWVudCBLZXlTdG9yZSwACQdUcnVzdAAMBgAcBzoAIwhsb2FkcwAWCyBjb250YWluaW5nIHRydXN0ZWQgc2VydmVyIGNlcnRzXG4ALA0AYggAKwxzaWduZWQgYwCBBgYAMQUKAIETBi0-K1MARwU6IFJlcXVlc3RzIHByb3RlY3RlZCByZXNvdXJjZQoAHgYtPi0AgSQIUHJlc2VudHMAfgwASQoAgVQROiBWZXJpZmllAB0UAIICCwBXC1ZhbGlkYXRlZABGEQCCRAgAgSgLAIFPCwBNCACCaggAgSoLUmV0dXJuABoUAIF8CwCBUQkASAwAgXkHAIF2C0Fja25vd2xlZGdlcyB2AIEmBmlvbgCCTgkAgk4IQWNjZXNzZQCCQhQ&amp;s=default" alt="Client Certificate Flow" /></p>

<p>The JDK ships with a tool called <strong>Keytool</strong>. It manages a JKS of cryptographic keys, X.509 certificate chains, and trusted certificates.</p>

<h3 id="creating-keystores-and-truststores-with-keytool">Creating KeyStores and TrustStores with Keytool</h3>

<p>Create the Server’s KeyStore from the PKCS12 file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rhowlett@SL-MBP-RHOWLETT.local:~/dev/robinhowlett/github/everything-ssl/src/main/resources/ssl 
| =&gt; keytool -importkeystore -deststorepass snaplogic -destkeypass snaplogic -destkeystore server_keystore.jks -srckeystore server-cert.p12 -srcstoretype PKCS12 -srcstorepass snaplogic -alias server
</code></pre></div></div>

<p>View the server keystore to confirm it now contains the server’s cert:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rhowlett@SL-MBP-RHOWLETT.local:~/dev/robinhowlett/github/everything-ssl/src/main/resources/ssl 
| =&gt; keytool -list -v -keystore server_keystore.jks 
Enter keystore password:  

Keystore type: JKS
Keystore provider: SUN

Your keystore contains 1 entry

Alias name: server
Creation date: Jan 4, 2016
Entry type: PrivateKeyEntry
Certificate chain length: 2
Certificate[1]:
Owner: CN=localhost, OU=SnapTeam, O=SnapLogic, ST=Colorado, C=US
Issuer: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Serial number: 100001
Valid from: Tue Oct 06 13:15:13 MDT 2015 until: Wed Oct 05 13:15:13 MDT 2016
Certificate fingerprints:
	 MD5:  62:83:6B:84:1B:CB:DE:26:CA:E0:9D:E8:04:84:B6:C1
	 SHA1: AD:D4:27:FF:9A:68:77:25:95:C3:A2:BE:F6:22:AD:82:5C:2B:AF:EB
	 SHA256: 8D:8D:EA:E5:7C:7A:E9:42:C9:9E:71:2A:76:C7:BE:BE:34:CC:4A:CC:83:ED:FE:C8:8E:C6:06:D2:D8:89:59:4A
	 Signature algorithm name: SHA512withRSA
	 Version: 1
Certificate[2]:
Owner: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Issuer: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Serial number: e4e00ed07233a969
Valid from: Tue Oct 06 13:14:51 MDT 2015 until: Wed Oct 05 13:14:51 MDT 2016
Certificate fingerprints:
	 MD5:  F3:5E:28:E4:28:47:F2:EC:82:E2:BD:16:31:DC:90:02
	 SHA1: 6F:0F:49:BA:A9:30:01:E9:4C:60:B3:A1:85:7D:BB:C6:79:1F:41:7B
	 SHA256: A7:9D:25:E4:A6:34:8A:A3:5B:9A:CD:F3:62:D0:D8:2F:6A:A0:71:6A:6D:19:F3:04:A1:FD:BC:FB:21:40:DE:A1
	 Signature algorithm name: SHA512withRSA
	 Version: 3

Extensions: 

#1: ObjectId: 2.5.29.35 Criticality=false
AuthorityKeyIdentifier [
KeyIdentifier [
0000: 03 09 12 6E 8B DD 7A 80   FB F5 21 AB 75 D9 B8 49  ...n..z...!.u..I
0010: 79 5B 61 1F                                        y[a.
]
[CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US]
SerialNumber: [    e4e00ed0 7233a969]
]

#2: ObjectId: 2.5.29.19 Criticality=false
BasicConstraints:[
  CA:true
  PathLen:2147483647
]

#3: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 03 09 12 6E 8B DD 7A 80   FB F5 21 AB 75 D9 B8 49  ...n..z...!.u..I
0010: 79 5B 61 1F                                        y[a.
]
]



*******************************************
*******************************************
</code></pre></div></div>

<p>Create the client’s truststore and import the server’s public certificate:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rhowlett@SL-MBP-RHOWLETT.local:~/dev/robinhowlett/github/everything-ssl/src/main/resources/ssl 
| =&gt; keytool -import -v -trustcacerts -keystore client_truststore.jks -storepass snaplogic -alias server -file /etc/apache2/ssl/server-cert.pem
Owner: CN=localhost, OU=SnapTeam, O=SnapLogic, ST=Colorado, C=US
Issuer: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Serial number: 100001
Valid from: Tue Oct 06 13:15:13 MDT 2015 until: Wed Oct 05 13:15:13 MDT 2016
Certificate fingerprints:
	 MD5:  62:83:6B:84:1B:CB:DE:26:CA:E0:9D:E8:04:84:B6:C1
	 SHA1: AD:D4:27:FF:9A:68:77:25:95:C3:A2:BE:F6:22:AD:82:5C:2B:AF:EB
	 SHA256: 8D:8D:EA:E5:7C:7A:E9:42:C9:9E:71:2A:76:C7:BE:BE:34:CC:4A:CC:83:ED:FE:C8:8E:C6:06:D2:D8:89:59:4A
	 Signature algorithm name: SHA512withRSA
	 Version: 1
Trust this certificate? [no]:  yes
Certificate was added to keystore
[Storing client_truststore.jks]
</code></pre></div></div>

<p>View the client’s truststore to confirm it contains the server’s cert:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rhowlett@SL-MBP-RHOWLETT.local:~/dev/robinhowlett/github/everything-ssl/src/main/resources/ssl 
| =&gt; keytool -list -v -keystore client_truststore.jks 
Enter keystore password:  

Keystore type: JKS
Keystore provider: SUN

Your keystore contains 1 entry

Alias name: server
Creation date: Jan 4, 2016
Entry type: trustedCertEntry

Owner: CN=localhost, OU=SnapTeam, O=SnapLogic, ST=Colorado, C=US
Issuer: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Serial number: 100001
Valid from: Tue Oct 06 13:15:13 MDT 2015 until: Wed Oct 05 13:15:13 MDT 2016
Certificate fingerprints:
	 MD5:  62:83:6B:84:1B:CB:DE:26:CA:E0:9D:E8:04:84:B6:C1
	 SHA1: AD:D4:27:FF:9A:68:77:25:95:C3:A2:BE:F6:22:AD:82:5C:2B:AF:EB
	 SHA256: 8D:8D:EA:E5:7C:7A:E9:42:C9:9E:71:2A:76:C7:BE:BE:34:CC:4A:CC:83:ED:FE:C8:8E:C6:06:D2:D8:89:59:4A
	 Signature algorithm name: SHA512withRSA
	 Version: 1


*******************************************
*******************************************
</code></pre></div></div>

<h4 id="one-way-ssl">One-Way SSL</h4>

<p>At this point we have enough to demonstrate one-way SSL with the local test <code class="highlighter-rouge">HttpServer</code> instance. The <code class="highlighter-rouge">createLocalTestServer</code> method instantiates an embedded <code class="highlighter-rouge">HttpServer</code> instance with an (optional) <code class="highlighter-rouge">sslContext</code> (<code class="highlighter-rouge">null</code> meaning HTTP-only) and a <code class="highlighter-rouge">boolean</code> “forceSSLAuth” indicating if client certificates are required or not:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">protected</span> <span class="n">HttpServer</span> <span class="nf">createLocalTestServer</span><span class="o">(</span><span class="n">SSLContext</span> <span class="n">sslContext</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">forceSSLAuth</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">UnknownHostException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="n">ServerBootstrap</span><span class="o">.</span><span class="na">bootstrap</span><span class="o">()</span>
            <span class="o">.</span><span class="na">setLocalAddress</span><span class="o">(</span><span class="n">Inet4Address</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">setSslContext</span><span class="o">(</span><span class="n">sslContext</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setSslSetupHandler</span><span class="o">(</span><span class="n">socket</span> <span class="o">-&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="na">setNeedClientAuth</span><span class="o">(</span><span class="n">forceSSLAuth</span><span class="o">))</span>
            <span class="o">.</span><span class="na">registerHandler</span><span class="o">(</span><span class="s">"*"</span><span class="o">,</span>
                    <span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">context</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">response</span><span class="o">.</span><span class="na">setStatusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">SC_OK</span><span class="o">))</span>
            <span class="o">.</span><span class="na">create</span><span class="o">();</span>

    <span class="k">return</span> <span class="n">server</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">getStore</code> method loads the JKS files from the classpath, and the <code class="highlighter-rouge">getKeyManagers</code> and <code class="highlighter-rouge">getTrustManagers</code> methods turn that store into the respective <code class="highlighter-rouge">Key-</code> or <code class="highlighter-rouge">TrustManager</code> arrays that are used to initialize an <code class="highlighter-rouge">SSLContext</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">JAVA_KEYSTORE</span> <span class="o">=</span> <span class="s">"jks"</span><span class="o">;</span>

<span class="cm">/**
 * KeyStores provide credentials, TrustStores verify credentials.
 *
 * Server KeyStores stores the server's private keys, and certificates for corresponding public
 * keys. Used here for HTTPS connections over localhost.
 *
 * Client TrustStores store servers' certificates.
 */</span>
<span class="kd">protected</span> <span class="n">KeyStore</span> <span class="nf">getStore</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">storeFileName</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">char</span><span class="o">[]</span> <span class="n">password</span><span class="o">)</span> <span class="kd">throws</span>
        <span class="n">KeyStoreException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">CertificateException</span><span class="o">,</span> <span class="n">NoSuchAlgorithmException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">KeyStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">KeyStore</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">JAVA_KEYSTORE</span><span class="o">);</span>
    <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResource</span><span class="o">(</span><span class="n">storeFileName</span><span class="o">);</span>
    <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">openStream</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">store</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">inputStream</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">store</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * KeyManagers decide which authentication credentials (e.g. certs) should be sent to the remote
 * host for authentication during the SSL handshake.
 *
 * Server KeyManagers use their private keys during the key exchange algorithm and send
 * certificates corresponding to their public keys to the clients. The certificate comes from
 * the KeyStore.
 */</span>
<span class="kd">protected</span> <span class="n">KeyManager</span><span class="o">[]</span> <span class="nf">getKeyManagers</span><span class="o">(</span><span class="n">KeyStore</span> <span class="n">store</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">char</span><span class="o">[]</span> <span class="n">password</span><span class="o">)</span> <span class="kd">throws</span>
        <span class="n">NoSuchAlgorithmException</span><span class="o">,</span> <span class="n">UnrecoverableKeyException</span><span class="o">,</span> <span class="n">KeyStoreException</span> <span class="o">{</span>
    <span class="n">KeyManagerFactory</span> <span class="n">keyManagerFactory</span> <span class="o">=</span> <span class="n">KeyManagerFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span>
            <span class="n">KeyManagerFactory</span><span class="o">.</span><span class="na">getDefaultAlgorithm</span><span class="o">());</span>
    <span class="n">keyManagerFactory</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">store</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">keyManagerFactory</span><span class="o">.</span><span class="na">getKeyManagers</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * TrustManagers determine if the remote connection should be trusted or not.
 *
 * Clients will use certificates stored in their TrustStores to verify identities of servers.
 * Servers will use certificates stored in their TrustStores to verify identities of clients.
 */</span>
<span class="kd">protected</span> <span class="n">TrustManager</span><span class="o">[]</span> <span class="nf">getTrustManagers</span><span class="o">(</span><span class="n">KeyStore</span> <span class="n">store</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchAlgorithmException</span><span class="o">,</span>
        <span class="n">KeyStoreException</span> <span class="o">{</span>
    <span class="n">TrustManagerFactory</span> <span class="n">trustManagerFactory</span> <span class="o">=</span>
            <span class="n">TrustManagerFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">TrustManagerFactory</span><span class="o">.</span><span class="na">getDefaultAlgorithm</span><span class="o">());</span>
    <span class="n">trustManagerFactory</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">store</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">trustManagerFactory</span><span class="o">.</span><span class="na">getTrustManagers</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">SSLContext</code> is created and initialized like so:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/*
Create an SSLContext for the server using the server's JKS. This instructs the server to
present its certificate when clients connect over HTTPS.
 */</span>
<span class="kd">protected</span> <span class="n">SSLContext</span> <span class="nf">createServerSSLContext</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">storeFileName</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">char</span><span class="o">[]</span>
        <span class="n">password</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CertificateException</span><span class="o">,</span> <span class="n">NoSuchAlgorithmException</span><span class="o">,</span> <span class="n">KeyStoreException</span><span class="o">,</span>
        <span class="n">IOException</span><span class="o">,</span> <span class="n">UnrecoverableKeyException</span><span class="o">,</span> <span class="n">KeyManagementException</span> <span class="o">{</span>
    <span class="n">KeyStore</span> <span class="n">serverKeyStore</span> <span class="o">=</span> <span class="n">getStore</span><span class="o">(</span><span class="n">storeFileName</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
    <span class="n">KeyManager</span><span class="o">[]</span> <span class="n">serverKeyManagers</span> <span class="o">=</span> <span class="n">getKeyManagers</span><span class="o">(</span><span class="n">serverKeyStore</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
    <span class="n">TrustManager</span><span class="o">[]</span> <span class="n">serverTrustManagers</span> <span class="o">=</span> <span class="n">getTrustManagers</span><span class="o">(</span><span class="n">serverKeyStore</span><span class="o">);</span>

    <span class="n">SSLContext</span> <span class="n">sslContext</span> <span class="o">=</span> <span class="n">SSLContexts</span><span class="o">.</span><span class="na">custom</span><span class="o">().</span><span class="na">useProtocol</span><span class="o">(</span><span class="s">"TLS"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="n">sslContext</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">serverKeyManagers</span><span class="o">,</span> <span class="n">serverTrustManagers</span><span class="o">,</span> <span class="k">new</span> <span class="n">SecureRandom</span><span class="o">());</span>

    <span class="k">return</span> <span class="n">sslContext</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The following unit test shows making a HTTPS request to the local test <code class="highlighter-rouge">HttpServer</code> instance and validating the server’s public certificate with the client’s truststore:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ONE_WAY_SSL</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// no client certificates</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">char</span><span class="o">[]</span> <span class="n">KEYPASS_AND_STOREPASS_VALUE</span> <span class="o">=</span> <span class="s">"snaplogic"</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">();</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SERVER_KEYSTORE</span> <span class="o">=</span> <span class="s">"ssl/server_keystore.jks"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CLIENT_TRUSTSTORE</span> <span class="o">=</span> <span class="s">"ssl/client_truststore.jks"</span><span class="o">;</span>
   
<span class="kd">private</span> <span class="n">CloseableHttpClient</span> <span class="n">httpclient</span><span class="o">;</span>

<span class="nd">@Before</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">httpclient</span> <span class="o">=</span> <span class="n">HttpClients</span><span class="o">.</span><span class="na">createDefault</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">httpsRequest_With1WaySSLAndValidatingCertsAndClientTrustStore_Returns200OK</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">SSLContext</span> <span class="n">serverSSLContext</span> <span class="o">=</span>
            <span class="n">createServerSSLContext</span><span class="o">(</span><span class="n">SERVER_KEYSTORE</span><span class="o">,</span> <span class="n">KEYPASS_AND_STOREPASS_VALUE</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="n">createLocalTestServer</span><span class="o">(</span><span class="n">serverSSLContext</span><span class="o">,</span> <span class="n">ONE_WAY_SSL</span><span class="o">);</span>
    <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

    <span class="n">String</span> <span class="n">baseUrl</span> <span class="o">=</span> <span class="n">getBaseUrl</span><span class="o">(</span><span class="n">server</span><span class="o">);</span>

    <span class="c1">// The server certificate was imported into the client's TrustStore (using keytool -import)</span>
    <span class="n">KeyStore</span> <span class="n">clientTrustStore</span> <span class="o">=</span> <span class="n">getStore</span><span class="o">(</span><span class="n">CLIENT_TRUSTSTORE</span><span class="o">,</span> <span class="n">KEYPASS_AND_STOREPASS_VALUE</span><span class="o">);</span>

    <span class="n">SSLContext</span> <span class="n">sslContext</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nf">SSLContextBuilder</span><span class="o">().</span><span class="na">loadTrustMaterial</span><span class="o">(</span>
                    <span class="n">clientTrustStore</span><span class="o">,</span> <span class="k">new</span> <span class="n">TrustSelfSignedStrategy</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>

    <span class="n">httpclient</span> <span class="o">=</span> <span class="n">HttpClients</span><span class="o">.</span><span class="na">custom</span><span class="o">().</span><span class="na">setSSLContext</span><span class="o">(</span><span class="n">sslContext</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

    <span class="cm">/*
    The HTTP client will now validate the server's presented certificate using its TrustStore.
     Since the cert was imported to the client's TrustStore explicitly (see above), the
     certificate will validate and the request will succeed
     */</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">HttpResponse</span> <span class="n">httpResponse</span> <span class="o">=</span> <span class="n">httpclient</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">HttpGet</span><span class="o">(</span><span class="s">"https://"</span> <span class="o">+</span> <span class="n">baseUrl</span> <span class="o">+</span> <span class="s">"/echo/this"</span><span class="o">));</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">httpResponse</span><span class="o">.</span><span class="na">getStatusLine</span><span class="o">().</span><span class="na">getStatusCode</span><span class="o">(),</span> <span class="n">equalTo</span><span class="o">(</span><span class="mi">200</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">server</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">protected</span> <span class="n">String</span> <span class="nf">getBaseUrl</span><span class="o">(</span><span class="n">HttpServer</span> <span class="n">server</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">server</span><span class="o">.</span><span class="na">getInetAddress</span><span class="o">().</span><span class="na">getHostName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">server</span><span class="o">.</span><span class="na">getLocalPort</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The above unit test is included in the <a href="https://github.com/robinhowlett/everything-ssl"><code class="highlighter-rouge">everything-ssl</code> GitHub project</a>, along with the following (which are useful to see the  behavior when the SSL handshake fails, when server certificate validation is bypassed, malformed contexts etc.)</p>

<ul>
  <li><code class="highlighter-rouge">execute_WithNoScheme_ThrowsClientProtocolExceptionInvalidHostname</code></li>
  <li><code class="highlighter-rouge">httpRequest_Returns200OK</code></li>
  <li><code class="highlighter-rouge">httpsRequest_WithNoSSLContext_ThrowsSSLExceptionPlaintextConnection</code></li>
  <li><code class="highlighter-rouge">httpsRequest_With1WaySSLAndValidatingCertsButNoClientTrustStore_ThrowsSSLException</code></li>
  <li><code class="highlighter-rouge">httpsRequest_With1WaySSLAndTrustingAllCertsButNoClientTrustStore_Returns200OK</code></li>
  <li><code class="highlighter-rouge">httpsRequest_With1WaySSLAndValidatingCertsAndClientTrustStore_Returns200OK</code></li>
</ul>

<h4 id="two-way-ssl-client-certificates">Two-Way SSL (Client Certificates)</h4>

<p>To configure two-way SSL we have to create the server’s truststore and create the client’s keystore.</p>

<p>Since the client’s certificate is signed by a CA we created ourselves, import the CA cert into the server truststore:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rhowlett@SL-MBP-RHOWLETT.local:~/dev/robinhowlett/github/everything-ssl/src/main/resources/ssl 
| =&gt; keytool -import -v -trustcacerts -keystore server_truststore.jks -storepass snaplogic -file /etc/apache2/ssl/cacert.pem -alias cacert
Owner: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Issuer: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Serial number: e4e00ed07233a969
Valid from: Tue Oct 06 15:14:51 EDT 2015 until: Wed Oct 05 15:14:51 EDT 2016
Certificate fingerprints:
	 MD5:  F3:5E:28:E4:28:47:F2:EC:82:E2:BD:16:31:DC:90:02
	 SHA1: 6F:0F:49:BA:A9:30:01:E9:4C:60:B3:A1:85:7D:BB:C6:79:1F:41:7B
	 SHA256: A7:9D:25:E4:A6:34:8A:A3:5B:9A:CD:F3:62:D0:D8:2F:6A:A0:71:6A:6D:19:F3:04:A1:FD:BC:FB:21:40:DE:A1
	 Signature algorithm name: SHA512withRSA
	 Version: 3

Extensions: 

#1: ObjectId: 2.5.29.35 Criticality=false
AuthorityKeyIdentifier [
KeyIdentifier [
0000: 03 09 12 6E 8B DD 7A 80   FB F5 21 AB 75 D9 B8 49  ...n..z...!.u..I
0010: 79 5B 61 1F                                        y[a.
]
[CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US]
SerialNumber: [    e4e00ed0 7233a969]
]

#2: ObjectId: 2.5.29.19 Criticality=false
BasicConstraints:[
  CA:true
  PathLen:2147483647
]

#3: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 03 09 12 6E 8B DD 7A 80   FB F5 21 AB 75 D9 B8 49  ...n..z...!.u..I
0010: 79 5B 61 1F                                        y[a.
]
]

Trust this certificate? [no]:  yes
Certificate was added to keystore
[Storing server_truststore.jks]
</code></pre></div></div>

<p>Viewing the server truststore will show the CA’s certificate:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rhowlett@SL-MBP-RHOWLETT.local:~/dev/robinhowlett/github/everything-ssl/src/main/resources/ssl 
| =&gt; keytool -list -v -keystore server_truststore.jks 
Enter keystore password:  

Keystore type: JKS
Keystore provider: SUN

Your keystore contains 1 entry

Alias name: cacert
Creation date: Jan 5, 2016
Entry type: trustedCertEntry

Owner: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Issuer: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Serial number: e4e00ed07233a969
Valid from: Tue Oct 06 15:14:51 EDT 2015 until: Wed Oct 05 15:14:51 EDT 2016
Certificate fingerprints:
	 MD5:  F3:5E:28:E4:28:47:F2:EC:82:E2:BD:16:31:DC:90:02
	 SHA1: 6F:0F:49:BA:A9:30:01:E9:4C:60:B3:A1:85:7D:BB:C6:79:1F:41:7B
	 SHA256: A7:9D:25:E4:A6:34:8A:A3:5B:9A:CD:F3:62:D0:D8:2F:6A:A0:71:6A:6D:19:F3:04:A1:FD:BC:FB:21:40:DE:A1
	 Signature algorithm name: SHA512withRSA
	 Version: 3

Extensions: 

#1: ObjectId: 2.5.29.35 Criticality=false
AuthorityKeyIdentifier [
KeyIdentifier [
0000: 03 09 12 6E 8B DD 7A 80   FB F5 21 AB 75 D9 B8 49  ...n..z...!.u..I
0010: 79 5B 61 1F                                        y[a.
]
[CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US]
SerialNumber: [    e4e00ed0 7233a969]
]

#2: ObjectId: 2.5.29.19 Criticality=false
BasicConstraints:[
  CA:true
  PathLen:2147483647
]

#3: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 03 09 12 6E 8B DD 7A 80   FB F5 21 AB 75 D9 B8 49  ...n..z...!.u..I
0010: 79 5B 61 1F                                        y[a.
]
]



*******************************************
*******************************************
</code></pre></div></div>

<p>Finally, the client keystore stores the client certificate that will presented to the server for SSL authentication. Import the cert from client’s PKCS12 file (created above):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rhowlett@SL-MBP-RHOWLETT.local:~/dev/robinhowlett/github/everything-ssl/src/main/resources/ssl 
| =&gt; keytool -importkeystore -srckeystore /etc/apache2/ssl/client-cert.p12 -srcstoretype pkcs12 -destkeystore client_keystore.jks -deststoretype jks -deststorepass snaplogic
Enter source keystore password:  
Entry for alias client successfully imported.
Import command completed:  1 entries successfully imported, 0 entries failed or cancelled
</code></pre></div></div>

<p>Viewing the created <code class="highlighter-rouge">client_keystore.jks</code> file will show the <code class="highlighter-rouge">client</code> entry in the keystore:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| rhowlett@SL-MBP-RHOWLETT.local:~/dev/robinhowlett/github/everything-ssl/src/main/resources/ssl 
| =&gt; keytool -list -v -keystore client_keystore.jks 
Enter keystore password:  

Keystore type: JKS
Keystore provider: SUN

Your keystore contains 1 entry

Alias name: client
Creation date: Jan 4, 2016
Entry type: PrivateKeyEntry
Certificate chain length: 2
Certificate[1]:
Owner: CN=client, OU=SnapTeam, O=SnapLogic, ST=Colorado, C=US
Issuer: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Serial number: 100002
Valid from: Tue Oct 06 13:15:41 MDT 2015 until: Wed Oct 05 13:15:41 MDT 2016
Certificate fingerprints:
	 MD5:  F1:EF:60:64:48:DC:9B:C1:92:37:61:90:ED:48:01:1C
	 SHA1: C5:4B:1C:EF:85:C1:8C:5A:AA:74:54:49:F0:B5:97:F1:EC:34:49:6F
	 SHA256: B0:00:E4:C1:AE:03:92:95:9C:A2:BB:DB:13:3A:B6:38:BE:B4:BF:04:D0:72:41:6D:62:A6:93:D0:46:7E:3C:97
	 Signature algorithm name: SHA512withRSA
	 Version: 1
Certificate[2]:
Owner: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Issuer: CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US
Serial number: e4e00ed07233a969
Valid from: Tue Oct 06 13:14:51 MDT 2015 until: Wed Oct 05 13:14:51 MDT 2016
Certificate fingerprints:
	 MD5:  F3:5E:28:E4:28:47:F2:EC:82:E2:BD:16:31:DC:90:02
	 SHA1: 6F:0F:49:BA:A9:30:01:E9:4C:60:B3:A1:85:7D:BB:C6:79:1F:41:7B
	 SHA256: A7:9D:25:E4:A6:34:8A:A3:5B:9A:CD:F3:62:D0:D8:2F:6A:A0:71:6A:6D:19:F3:04:A1:FD:BC:FB:21:40:DE:A1
	 Signature algorithm name: SHA512withRSA
	 Version: 3

Extensions: 

#1: ObjectId: 2.5.29.35 Criticality=false
AuthorityKeyIdentifier [
KeyIdentifier [
0000: 03 09 12 6E 8B DD 7A 80   FB F5 21 AB 75 D9 B8 49  ...n..z...!.u..I
0010: 79 5B 61 1F                                        y[a.
]
[CN=localhost, OU=SnapTeam, O=SnapLogic, L=Boulder, ST=Colorado, C=US]
SerialNumber: [    e4e00ed0 7233a969]
]

#2: ObjectId: 2.5.29.19 Criticality=false
BasicConstraints:[
  CA:true
  PathLen:2147483647
]

#3: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 03 09 12 6E 8B DD 7A 80   FB F5 21 AB 75 D9 B8 49  ...n..z...!.u..I
0010: 79 5B 61 1F                                        y[a.
]
]



*******************************************
*******************************************
</code></pre></div></div>

<blockquote>
  <p>So, in summary, the server will present the certificate in its keystore to the client. The client will use its truststore to validate the server’s certificate. The client will present its certificate in its keystore to the server, and the server will validate the client certificate’s chain using the CA certificate in the server’s truststore.</p>
</blockquote>

<p>The <code class="highlighter-rouge">HttpServer</code> instance can now be created with the <code class="highlighter-rouge">forceSSLAuth</code> parameter set to <code class="highlighter-rouge">true</code> (see the <code class="highlighter-rouge">TWO_WAY_SSL</code> boolean) which will require client certificates. The client’s <code class="highlighter-rouge">SSLContext</code> now has both the client truststore and keystore loaded:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">TWO_WAY_SSL</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// client certificates mandatory</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">httpsRequest_With2WaySSLAndHasValidKeyStoreAndTrustStore_Returns200OK</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">SSLContext</span> <span class="n">serverSSLContext</span> <span class="o">=</span>
            <span class="n">createServerSSLContext</span><span class="o">(</span><span class="n">SERVER_KEYSTORE</span><span class="o">,</span> <span class="n">KEYPASS_AND_STOREPASS_VALUE</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="n">createLocalTestServer</span><span class="o">(</span><span class="n">serverSSLContext</span><span class="o">,</span> <span class="n">TWO_WAY_SSL</span><span class="o">);</span>
    <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

    <span class="n">String</span> <span class="n">baseUrl</span> <span class="o">=</span> <span class="n">getBaseUrl</span><span class="o">(</span><span class="n">server</span><span class="o">);</span>

    <span class="n">KeyStore</span> <span class="n">clientTrustStore</span> <span class="o">=</span> <span class="n">getStore</span><span class="o">(</span><span class="n">CLIENT_TRUSTSTORE</span><span class="o">,</span> <span class="n">KEYPASS_AND_STOREPASS_VALUE</span><span class="o">);</span>
    <span class="n">KeyStore</span> <span class="n">clientKeyStore</span> <span class="o">=</span> <span class="n">getStore</span><span class="o">(</span><span class="n">CLIENT_KEYSTORE</span><span class="o">,</span> <span class="n">KEYPASS_AND_STOREPASS_VALUE</span><span class="o">);</span>

    <span class="n">SSLContext</span> <span class="n">sslContext</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nf">SSLContextBuilder</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">loadTrustMaterial</span><span class="o">(</span><span class="n">clientTrustStore</span><span class="o">,</span> <span class="k">new</span> <span class="n">TrustSelfSignedStrategy</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">loadKeyMaterial</span><span class="o">(</span><span class="n">clientKeyStore</span><span class="o">,</span> <span class="n">KEYPASS_AND_STOREPASS_VALUE</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="n">httpclient</span> <span class="o">=</span> <span class="n">HttpClients</span><span class="o">.</span><span class="na">custom</span><span class="o">().</span><span class="na">setSSLContext</span><span class="o">(</span><span class="n">sslContext</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">CloseableHttpResponse</span> <span class="n">httpResponse</span> <span class="o">=</span> <span class="n">httpclient</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">HttpGet</span><span class="o">(</span><span class="s">"https://"</span> <span class="o">+</span> <span class="n">baseUrl</span> <span class="o">+</span> <span class="s">"/echo/this"</span><span class="o">));</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">httpResponse</span><span class="o">.</span><span class="na">getStatusLine</span><span class="o">().</span><span class="na">getStatusCode</span><span class="o">(),</span> <span class="n">equalTo</span><span class="o">(</span><span class="mi">200</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">server</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Once again, the above unit test is included in the <a href="https://github.com/robinhowlett/everything-ssl"><code class="highlighter-rouge">everything-ssl</code> GitHub project</a>, along with the following:</p>

<ul>
  <li><code class="highlighter-rouge">httpsRequest_With2WaySSLAndUnknownClientCert_ThrowsSSLExceptionBadCertificate</code></li>
  <li><code class="highlighter-rouge">httpsRequest_With2WaySSLButNoClientKeyStore_ThrowsSSLExceptionBadCertificate</code></li>
</ul>

<h2 id="two-way-ssl-authentication-with-spring-boot-embedded-tomcat-and-resttemplate">Two-Way SSL Authentication with Spring Boot, embedded Tomcat and RestTemplate</h2>

<p><a href="http://projects.spring.io/spring-boot/">Spring Boot</a> “takes an opinionated view of building production-ready Spring (Java) applications”. Spring Boot’s <a href="http://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/htmlsingle/#using-boot-starter-poms">Starter POMs</a> and <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-boot-auto-configuration.html">auto-configuration</a> make it quite easy to get going:</p>

<p>``` xml pom.xml
<?xml version="1.0" encoding="UTF-8"?></p>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>1.3.1.RELEASE</version>
        <relativePath /> <!-- lookup parent from repository -->
    </parent>

	<groupId>com.robinhowlett</groupId>
	<artifactId>everything-ssl</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<packaging>jar</packaging>

	<name>everything-ssl</name>
	<description>Spring Boot and SSL</description>

	<properties>
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
		<java.version>1.8</java.version>

		<commons-io-version>2.4</commons-io-version>
	</properties>

	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpclient</artifactId>
        </dependency>
        <dependency>
            <groupId>commons-io</groupId>
            <artifactId>commons-io</artifactId>
            <version>${commons-io-version}</version>
        </dependency>
		
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
	</dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-failsafe-plugin</artifactId>
                <version>2.19</version>
                <executions>
                    <execution>
                        <goals>
                            <goal>integration-test</goal>
                            <goal>verify</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

</project>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
The Spring Boot documentation [describes the properties required to configure SSL](https://docs.spring.io/spring-boot/docs/current/reference/html/howto-embedded-servlet-containers.html#howto-configure-ssl). I wanted however to support both HTTP and HTTPS for testing purposes, so an explicit SSL Connector for the embedded Tomcat container needed to be created:

``` java Config.java

/**
 * Configure embedded Tomcat and SSL connectors
 */
@Configuration
public class Config {

    @Autowired
    private Environment env;

    // Embedded Tomcat with HTTP and HTTPS support
    @Bean
    public EmbeddedServletContainerFactory servletContainer() {
        TomcatEmbeddedServletContainerFactory tomcat = new
                TomcatEmbeddedServletContainerFactory();
        tomcat.addAdditionalTomcatConnectors(createSSLConnector());
        return tomcat;
    }

    // Creates an SSL connector, sets two-way SSL, key- and trust stores, passwords, ports etc.
    protected Connector createSSLConnector() {
        Connector connector = new Connector(Http11Protocol.class.getCanonicalName());
        Http11Protocol protocol = (Http11Protocol) connector.getProtocolHandler();

        File keyStore = null;
        File trustStore = null;

        try {
            keyStore = getKeyStoreFile();
        } catch (IOException e) {
            throw new IllegalStateException("Cannot access keyStore: [" + keyStore + "] or " +
                    "trustStore: [" + trustStore + "]", e);
        }

        trustStore = keyStore;

        connector.setPort(env.getRequiredProperty("ssl.port", Integer.class));
        connector.setScheme(env.getRequiredProperty("ssl.scheme"));
        connector.setSecure(env.getRequiredProperty("ssl.secure", Boolean.class));

        protocol.setClientAuth(env.getRequiredProperty("ssl.client-auth"));
        protocol.setSSLEnabled(env.getRequiredProperty("ssl.enabled", Boolean.class));

        protocol.setKeyPass(env.getRequiredProperty("ssl.key-password"));
        protocol.setKeystoreFile(keyStore.getAbsolutePath());
        protocol.setKeystorePass(env.getRequiredProperty("ssl.store-password"));
        protocol.setTruststoreFile(trustStore.getAbsolutePath());
        protocol.setTruststorePass(env.getRequiredProperty("ssl.store-password"));
        protocol.setCiphers(env.getRequiredProperty("ssl.ciphers"));

        return connector;
    }

    // support loading the JKS from the classpath (to get around Tomcat limitation)
    private File getKeyStoreFile() throws IOException {
        ClassPathResource resource = new ClassPathResource(env.getRequiredProperty("ssl.store"));

        // Tomcat won't allow reading File from classpath so read as InputStream into temp File
        File jks = File.createTempFile("server_keystore", ".jks");
        InputStream inputStream = resource.getInputStream();
        try {
            FileUtils.copyInputStreamToFile(inputStream, jks);
        } finally {
            IOUtils.closeQuietly(inputStream);
        }

        return jks;
    }
}
</code></pre></div></div>

<p>The <code class="highlighter-rouge">application.properties</code> file then defines the required SSL properties:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssl.port=8443
ssl.scheme=https
ssl.secure=true
ssl.client-auth=true
ssl.enabled=true
ssl.key-password=snaplogic
ssl.store=ssl/server_keystore.jks
ssl.store-password=snaplogic
ssl.ciphers=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,TLS_DHE_DSS_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_SHA256,TLS_ECDHE_RSA_WITH_AES_128_SHA,TLS_ECDHE_ECDSA_WITH_AES_128_SHA,TLS_ECDHE_RSA_WITH_AES_256_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_SHA384,TLS_ECDHE_RSA_WITH_AES_256_SHA,TLS_ECDHE_ECDSA_WITH_AES_256_SHA,TLS_DHE_RSA_WITH_AES_128_SHA256,TLS_DHE_RSA_WITH_AES_128_SHA,TLS_DHE_DSS_WITH_AES_128_SHA256,TLS_DHE_RSA_WITH_AES_256_SHA256,TLS_DHE_DSS_WITH_AES_256_SHA,TLS_DHE_RSA_WITH_AES_256_SHA
</code></pre></div></div>

<p>The <code class="highlighter-rouge">ssl.client-auth=true</code> property enforces two-way SSL.</p>

<blockquote>
  <p>We are re-using the JKS files created earlier (above)</p>
</blockquote>

<p>A simple REST interface is defined to return JSON representations of Greeting instances:</p>

<p>``` java GreetingController.java</p>

<p>/**</p>
<ul>
  <li>
    <p>Just says hello
 */
@RestController
public class GreetingController {</p>

    <p>private static final String template = “Hello, %s!”;</p>

    <p>@RequestMapping(“/greeting”)
 public Greeting greet(
         @RequestParam(value = “name”, required = false, defaultValue = “World!”) String name) {
     return new Greeting(String.format(template, name));
 }</p>
  </li>
</ul>

<p>}</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	
Spring Security auto-configuration will enable basic authentication on the REST endpoint by default, so let's switch it off:

``` java HttpSecurityConfig.java

/**
 * Disable default-enabled basic auth
 */
@EnableWebSecurity
public class HttpSecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.httpBasic().disable();
    }

}
</code></pre></div></div>

<h3 id="integration-testing-ssl-authentication-with-springs-testresttemplate">Integration Testing SSL Authentication with Spring’s TestRestTemplate</h3>

<p>Spring Boot really is great - it was quite straightforward to write an integration test to demonstrate two-way SSL authentication with the application running on the embedded Tomcat container.</p>

<p>First I created an <code class="highlighter-rouge">integration-test.properties</code> file to set the HTTPS port to be different than then main application (the HTTP port will be set to a random open port by an annotation on the test itself). The only contents of this file is the <code class="highlighter-rouge">ssl.port</code> property. All the other properties will come from the <code class="highlighter-rouge">application.properties</code> file detailed above:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssl.port=54321
</code></pre></div></div>

<p>The integration test class has annotations that instruct it to run using the <code class="highlighter-rouge">SpringJUnit4ClassRunner</code>, the scan for <code class="highlighter-rouge">@Configuration</code> classes at the base package of the <code class="highlighter-rouge">EverythingSSLApplication</code> class, to choose a random available HTTP port with the <code class="highlighter-rouge">@WebIntegrationTest</code> annotation (which itself is a combination of the <code class="highlighter-rouge">@IntegrationTest</code> and <code class="highlighter-rouge">@WebAppConfiguration</code> annotations), and finally the <code class="highlighter-rouge">integration-test.properties</code> file is denoted as a <code class="highlighter-rouge">@TestPropertySource</code>.</p>

<p>``` java ITEverythingSSL.java</p>

<p>/**</p>
<ul>
  <li>
    <p>Integration test that uses the embedded Tomcat instance configured by this Spring Boot app
 */
@RunWith(SpringJUnit4ClassRunner.class)
@SpringApplicationConfiguration(classes = EverythingSSLApplication.class)
@WebIntegrationTest(randomPort = true)
@TestPropertySource(locations = “classpath:integration-test.properties”)
public class ITEverythingSSL {</p>

    <p>public static final String CLIENT_TRUSTSTORE = “ssl/client_truststore.jks”;
 public static final String CLIENT_KEYSTORE = “ssl/client_keystore.jks”;</p>

    <p>@Rule
 public ExpectedException thrown = ExpectedException.none();</p>

    <p>@Value(“${local.server.port}”)
 private int port = 0;</p>

    <p>@Value(“${ssl.port}”)
 private int sslPort = 0;</p>

    <p>@Value(“${ssl.store-password}”)
 private String storePassword;</p>

    <p>…
```</p>
  </li>
</ul>

<p>The first test confirms that plain HTTP is supported:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">rest_OverPlainHttp_GetsExpectedResponse</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">Greeting</span> <span class="n">expected</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Greeting</span><span class="o">(</span><span class="s">"Hello, Robin!"</span><span class="o">);</span>

    <span class="n">RestTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestRestTemplate</span><span class="o">();</span>

    <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Greeting</span><span class="o">&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span>
            <span class="n">template</span><span class="o">.</span><span class="na">getForEntity</span><span class="o">(</span><span class="s">"http://localhost:"</span> <span class="o">+</span> <span class="n">port</span> <span class="o">+</span> <span class="s">"/greeting?name={name}"</span><span class="o">,</span>
                    <span class="n">Greeting</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"Robin"</span><span class="o">);</span>

    <span class="n">assertThat</span><span class="o">(</span><span class="n">responseEntity</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">getContent</span><span class="o">(),</span> <span class="n">equalTo</span><span class="o">(</span><span class="n">expected</span><span class="o">.</span><span class="na">getContent</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-testing.html#boot-features-rest-templates-test-utility"><code class="highlighter-rouge">TestRestTemplate</code></a> is “a convenience subclass of Spring’s <code class="highlighter-rouge">RestTemplate</code> that is useful in integration tests”</p>
</blockquote>

<p>The <code class="highlighter-rouge">getRestTemplateForHTTPS</code> method creates a <code class="highlighter-rouge">TestRestTemplate</code> instance with an <code class="highlighter-rouge">SSLContext</code> set to support the client’s keystore and truststore:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">private</span> <span class="n">RestTemplate</span> <span class="nf">getRestTemplateForHTTPS</span><span class="o">(</span><span class="n">SSLContext</span> <span class="n">sslContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">SSLConnectionSocketFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SSLConnectionSocketFactory</span><span class="o">(</span><span class="n">sslContext</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">DefaultHostnameVerifier</span><span class="o">());</span>

    <span class="n">CloseableHttpClient</span> <span class="n">closeableHttpClient</span> <span class="o">=</span>
            <span class="n">HttpClientBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">().</span><span class="na">setSSLSocketFactory</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

    <span class="n">RestTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestRestTemplate</span><span class="o">();</span>
    <span class="n">HttpComponentsClientHttpRequestFactory</span> <span class="n">httpRequestFactory</span> <span class="o">=</span>
            <span class="o">(</span><span class="n">HttpComponentsClientHttpRequestFactory</span><span class="o">)</span> <span class="n">template</span><span class="o">.</span><span class="na">getRequestFactory</span><span class="o">();</span>
    <span class="n">httpRequestFactory</span><span class="o">.</span><span class="na">setHttpClient</span><span class="o">(</span><span class="n">closeableHttpClient</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">template</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The test that then demonstrates two-way SSL is quite simple:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">rest_WithTwoWaySSL_AuthenticatesAndGetsExpectedResponse</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">Greeting</span> <span class="n">expected</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Greeting</span><span class="o">(</span><span class="s">"Hello, Robin!"</span><span class="o">);</span>

    <span class="n">SSLContext</span> <span class="n">sslContext</span> <span class="o">=</span> <span class="n">SSLContexts</span><span class="o">.</span><span class="na">custom</span><span class="o">()</span>
            <span class="o">.</span><span class="na">loadKeyMaterial</span><span class="o">(</span>
                    <span class="n">getStore</span><span class="o">(</span><span class="n">CLIENT_KEYSTORE</span><span class="o">,</span> <span class="n">storePassword</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">()),</span>
                    <span class="n">storePassword</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">())</span>
            <span class="o">.</span><span class="na">loadTrustMaterial</span><span class="o">(</span>
                    <span class="n">getStore</span><span class="o">(</span><span class="n">CLIENT_TRUSTSTORE</span><span class="o">,</span> <span class="n">storePassword</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">()),</span>
                    <span class="k">new</span> <span class="nf">TrustSelfSignedStrategy</span><span class="o">())</span>
            <span class="o">.</span><span class="na">useProtocol</span><span class="o">(</span><span class="s">"TLS"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

    <span class="n">RestTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="n">getRestTemplateForHTTPS</span><span class="o">(</span><span class="n">sslContext</span><span class="o">);</span>

    <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Greeting</span><span class="o">&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span>
            <span class="n">template</span><span class="o">.</span><span class="na">getForEntity</span><span class="o">(</span><span class="s">"https://localhost:"</span> <span class="o">+</span> <span class="n">sslPort</span> <span class="o">+</span> <span class="s">"/greeting?name={name}"</span><span class="o">,</span>
                    <span class="n">Greeting</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"Robin"</span><span class="o">);</span>

    <span class="n">assertThat</span><span class="o">(</span><span class="n">responseEntity</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">getContent</span><span class="o">(),</span> <span class="n">equalTo</span><span class="o">(</span><span class="n">expected</span><span class="o">.</span><span class="na">getContent</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The following integration tests have also been included in the project:</p>

<ul>
  <li><code class="highlighter-rouge">rest_WithMissingClientCert_ThrowsSSLHandshakeExceptionBadCertificate</code></li>
  <li><code class="highlighter-rouge">rest_WithUntrustedServerCert_ThrowsSSLHandshakeExceptionUnableFindValidCertPath</code></li>
</ul>

<blockquote>
  <p>The companion Spring Boot application <a href="https://github.com/robinhowlett/everything-ssl">is available on GitHub</a></p>
</blockquote>

<h2 id="two-way-ssl-with-snaplogics-rest-snap">Two-Way SSL with SnapLogic’s REST Snap</h2>

<p>Naturally, SnapLogic’s REST Snap makes this all very easy:</p>

<p><img src="https://snaplogic.box.com/shared/static/xkv5tch8lk2k2jf1q0881ri6u0nio7a0.gif" alt="SnapLogic REST Snap" /></p>

<h4 id="thank-yous">Thank Yous</h4>

<p>Thank you to Ed Heneghan for correcting my initial mistakes.</p>

            </div>
            <footer class="post-footer">
                <div class="post-share">
                    <span class="post-share-title">Share:</span>
                    <a target="_blank" href="https://twitter.com/share?text=Everything+you+ever+wanted+to+know+about+SSL+%28but+were+afraid+to+ask%29&amp;url=http://www.robinhowlett.com/blog/2016/01/05/everything-you-ever-wanted-to-know-about-ssl-but-were-afraid-to-ask/">Twitter</a>
                    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.robinhowlett.com/blog/2016/01/05/everything-you-ever-wanted-to-know-about-ssl-but-were-afraid-to-ask/">Facebook</a>
                </div><!-- .share-post -->
            </footer>
            
<section id="comments-area" class="comments-area">
    <h2 class="comments-title">Comments</h2>
    <div class="comments-inside">
        <div id="disqus_thread"></div>
    </div><!-- .comments-inside -->
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section><!-- .comments-area -->
<script type="text/javascript">
    var disqus_shortname = 'robinhowlett';
    var disqus_developer = 0;
    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</section>

        </article>
        
        <section class="read-next inner">
            <h2 class="read-next-title">Read Next</h2>
            
            <article class="post">
                <header class="post-header">
                    <div class="post-meta">
                        <time class="published" datetime="August 6, 2015">August 6, 2015</time>
                    </div>
                    <h3 class="post-title"><a href="/blog/2015/08/06/farewell-sportslabs/">Farewell SportsLabs, Hello SnapLogic</a></h3>
                    <p class="post-tags">
                        
                        
                        
                        <a href='/tag/snaplogic/'>Snaplogic</a>
                        
                        
                        
                    </p>
                </header>
            </article>
            
            
            <article class="post">
                <header class="post-header">
                    <div class="post-meta">
                        <time class="published" datetime="November 12, 2016">November 12, 2016</time>
                    </div>
                    <h3 class="post-title"><a href="/blog/2016/11/12/building-a-google-chrome-extension-including-keyboard-shortcuts-and-copying-to-the-clipboard/">Building a Google Chrome Extension (Keyboard Shortcuts, Copying to the Clipboard, and Notifications)</a></h3>
                    <p class="post-tags">
                        
                        
                        
                        <a href='/tag/chrome/'>Chrome</a>
                        
                        
                        
                        <a href='/tag/snaplogic/'>Snaplogic</a>
                        
                        
                        
                    </p>
                </header>
            </article>
            
        </section><!-- .read-next -->

        <!-- Create a sorted array of tags -->
         
        <section class="tagcloud inner">
            <h2 class="tagcloud-title">Tags</h2>
            <div class="tag-links">
                
                <a href='http://www.robinhowlett.com/tag/chrome/'>chrome</a>
                
                <a href='http://www.robinhowlett.com/tag/dataviz/'>dataviz</a>
                
                <a href='http://www.robinhowlett.com/tag/horseracing/'>horseracing</a>
                
                <a href='http://www.robinhowlett.com/tag/jackson/'>jackson</a>
                
                <a href='http://www.robinhowlett.com/tag/java/'>java</a>
                
                <a href='http://www.robinhowlett.com/tag/rest/'>rest</a>
                
                <a href='http://www.robinhowlett.com/tag/sankey/'>sankey</a>
                
                <a href='http://www.robinhowlett.com/tag/snaplogic/'>snaplogic</a>
                
                <a href='http://www.robinhowlett.com/tag/spring/'>spring</a>
                
                <a href='http://www.robinhowlett.com/tag/spring-shell/'>spring-shell</a>
                
                <a href='http://www.robinhowlett.com/tag/ssl/'>ssl</a>
                
                <a href='http://www.robinhowlett.com/tag/tls/'>tls</a>
                
                <a href='http://www.robinhowlett.com/tag/wagering/'>wagering</a>
                
            </div><!-- .tag-links -->
        </section><!-- .tagcloud -->

    </main><!-- .site-main -->

                

                
                <footer id="colophon" class="site-footer">
    <p class="site-info inner">
        <a href="#">The Boy Wonders</a> &copy; 2019. Royce theme by
        <a target="_blank" href="https://justgoodthemes.com/">JustGoodThemes</a>.
        <br />
        Powered by <a target="_blank" href="https://jekyllrb.com/">Jekyll</a>.
    </p>
    <a id="back-to-top" class="back-to-top" href="#page">
        <span class="icon-arrow-up" aria-hidden="true"></span>
        <span class="screen-reader-text">Back to top</span>
    </a>
</footer><!-- .site-footer -->
            </div><!-- .inner-wide -->
        </div><!-- .site-content -->
    </div><!-- .site -->

    
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-35552317-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-35552317-2', { 'anonymize_ip': true });
  </script>

    <!-- Javascript Assets -->
    <script src="/assets/js/jquery-3.3.1.min.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/custom.js"></script>

</body>

</html>